<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard – Welding Shop</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="teacher.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
      /* Additional small styles for sorting arrows */
      th.sortable {
        cursor: pointer;
      }
      th.sortable::after {
        content: " ⇅";
        font-size: 0.8em;
        color: #888;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Welding Shop – Teacher Dashboard</h1>
      <div class="right" id="authStatus">Not logged in</div>
    </header>

    <main>
      <!-- ========================= -->
      <!-- LOGIN CARD -->
      <!-- ========================= -->
      <section class="card" id="loginCard">
        <h2>Teacher Login</h2>

        <label>Email:</label>
        <input type="email" id="loginEmail" required />

        <label>Password:</label>
        <input type="password" id="loginPassword" required />

        <button id="loginBtn" type="button" class="primary">Login</button>
        <p class="small-text" id="loginMessage"></p>
      </section>

      <!-- ========================= -->
      <!-- DASHBOARD CARD -->
      <!-- ========================= -->
      <section class="card" id="dashboardCard" style="display: none">
        <h2>Teacher Dashboard</h2>
        <p class="small-text">
          View and update issues and machine maintenance logs submitted in the
          shop.
        </p>

        <button class="secondary" id="logoutBtn">Log Out</button>

        <!-- Search Bar (Issues only) -->
        <input
          type="text"
          id="searchInput"
          placeholder="Search issues..."
          style="width: 100%; padding: 8px; margin: 16px 0; font-size: 16px"
        />

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="open">Open Issues</button>
          <button class="tab-btn" data-tab="solved">Solved Issues</button>
          <button class="tab-btn" data-tab="maintenance">Maintenance Form</button>
          <button class="tab-btn" data-tab="maintenanceLog">Maintenance Log</button>
          <button class="tab-btn" data-tab="stock">Stock</button>
          <button class="tab-btn" data-tab="booths">Booth Overview</button>
          <button class="tab-btn" data-tab="supervisor">Admin</button>
          
        </div>

        <!-- ========================= -->
        <!-- OPEN / SOLVED ISSUES TAB -->
        <!-- ========================= -->
        <div id="issuesTab" class="tab-content">
          <table id="issuesTable">
            <thead>
              <tr>
                <th class="sortable" data-key="studentName">Student</th>
                <th class="sortable" data-key="classPeriod">Period</th>
                <th class="sortable" data-key="boothNumber">Booth</th>
                <th class="sortable" data-key="processType">Process</th>
                <th class="sortable" data-key="issueDetails">Issue Details</th>
                <th class="sortable" data-key="status">Status</th>
                <th class="sortable" data-key="createdAt">Reported Date</th>
                <th class="sortable hidden" data-key="updateddate" id="closedDate">Closed Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ========================= -->
        <!-- MAINTENANCE LOG TAB -->
        <!-- ========================= -->
        <div id="maintenanceTab" class="tab-content hidden card">
          
            

          <div class="card">
            <h2>Maintenance Records</h2>

            <table id="maintenanceTable">
              <div class="card">
                <h3>Filters </h3>
                <!-- Filters -->
                <div
                  style="
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                    margin-bottom: 12px;
                  "
                >
                  <input
                    type="text"
                    id="maintSearch"
                    placeholder="Search machine or notes..."
                    style="flex: 1; padding: 8px"
                  />
                  <select id="maintStatusFilter" style="padding: 8px">
                    <option value="">All Statuses</option>
                    <option value="Operational">Operational</option>
                    <option value="Needs Service">Needs Service</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Out of Order">Out of Order</option>
                    <option value="Needs Consumables">Needs Consumables</option>
                  </select>
                  <input type="date" id="maintFromDate" style="padding: 8px" />
                  <input type="date" id="maintToDate" style="padding: 8px" />
                </div>
              <thead>
                <tr>
                  <th class="sortable" data-key="machine">Machine</th>
                  <th class="sortable" data-key="location">Location</th>
                  <th class="sortable" data-key="date">Date</th>
                  <th class="sortable" data-key="notes">Notes</th>
                  <th class="sortable" data-key="status">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <h2>Machine Maintenance Log</h2>
            <div class="card">
            <h3>Maintenance Form</h3>
            <!-- Form -->
            <form id="maintenanceForm" class="hidden">
              <input type="hidden" id="maintId" />

              <label>Machine Name</label>
              <input type="text" id="machine" required />

              <label>Location / Booth</label>
              <input type="text" id="location" required />

              <label>Date Serviced</label>
              <input type="date" id="date" required />

              <label>Notes / Maintenance Performed</label>
              <textarea id="notes" required></textarea>
              
              <label>Status</label>
              <select id="status">
                <option>Operational</option>
                <option>Needs Service</option>
                <option>In Progress</option>
                <option>Out of Order</option>
                <option>Needs Consumables</option>
              </select>

              <button type="submit" class="primary" id="maintSaveBtn">
                Save
              </button>
              </div>
              <button
                type="button"
                class="secondary"
                id="maintCancelEdit"
                style="display: none"
              >
                Cancel Edit
              </button>
            </form>
          </div>

        </div>

      <!-- ========================= -->
      <!-- MAINTENANCE LOG (HISTORY) TAB -->
      <!-- ========================= -->
      <div id="maintenanceLogTab" class="tab-content hidden card">
        
        <h2>Maintenance Log (Full History)</h2>
        
        <div class="card">
          <h3>Filters</h3>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">

            <!-- Search -->
            <input
              type="text"
              id="logSearch"
              placeholder="Search machine, notes, or location..."
              style="flex:1; padding:8px"
            />

            <!-- Status Filter -->
            <select id="logStatusFilter" style="padding:8px">
              <option value="">All Statuses</option>
              <option value="Operational">Operational</option>
              <option value="Needs Service">Needs Service</option>
              <option value="In Progress">In Progress</option>
              <option value="Out of Order">Out of Order</option>
            </select>

            <!-- Technician Filter -->
            <input
              type="text"
              id="logTechFilter"
              placeholder="Filter by technician..."
              style="padding:8px"
            />

            <!-- Date Range -->
            <input type="date" id="logFromDate" style="padding:8px" />
            <input type="date" id="logToDate" style="padding:8px" />

          </div>
        </div>

        <div class="card">
          <h3>All Maintenance Records</h3>
          <table id="maintenanceLogTable">
            <thead>
              <tr>
                <th class="sortable" data-key="machine">Machine</th>
                <th class="sortable" data-key="location">Location</th>
                <th class="sortable" data-key="date">Date</th>
                <th class="sortable" data-key="notes">Notes</th>
                <th class="sortable" data-key="status">Status</th>
                <th class="sortable" data-key="tech">Technician</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
    
      </div>

      
      <!-- ========== STOCK TAB ========== -->
      <div id="stockTab" class="tab-content hidden">
        <div class="card">
          <h2>Stock / Inventory</h2>

        
          <!-- Add / Edit Form -->
          <form id="stockForm">
            <input type="hidden" id="stockId" />

            <label>Part Type</label>
            <input type="text" id="stockPartType" required />

            <label>Machine Type</label>
            <select id="stockMachineType" required>
              <option value="">Loading types...</option>
            </select>

            <label>Part Number</label>
            <input type="text" id="stockPartNumber" required />

            <label>Amount</label>
            <input type="number" id="stockAmount" required />

            <button type="submit" class="primary">Save Part</button>
          </form>
        

          <h2 class="hidden">Inventory List</h2>
          <!-- Search -->
          <input
            type="text"
            id="stockSearch"
            placeholder="Search parts..."
            style="width: 100%; padding: 8px; margin-bottom: 16px;" 
            class="hidden"
          />

          <div id="stockCardsContainer"></div>

       
      </div>
      <!-- ========== TANK PSI SECTION ========== -->
      <div id="tankTab1" class="card hidden" style="margin-top: 24px;" >
        <h2>Tank PSI Tracking</h2>

        

        <!-- Add / Edit Form -->
        <form id="tankForm">
          <input type="hidden" id="tankId" />

          <label>Tank Name</label>
          <input type="text" id="tankName" required />

          <label>Air Type</label>
          <input type="text" id="tankAirType" required />

          <label>PSI</label>
          <input type="number" id="tankPSI" min="0" required />

          <button type="submit" class="primary">Save Tank</button>
        </form>
      </div>

      <div class="card hidden" id="tankTab">
        <h2>Tank List</h2>
        <!-- Search -->
        
        <input
          type="text"
          id="tankSearch"
          placeholder="Search tanks..."
          style="width: 100%; padding: 8px; margin-bottom: 16px;"
        />
        <a href="/tanks" >Tank Chart</a>
        <table id="tankTable">
          <thead>
            <tr>
              <th class="sortable" data-key="tankName">Tank</th>
              <th class="sortable" data-key="airType">Air Type</th>
              <th class="sortable" data-key="psi">PSI</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
        </div>

        <!-- MACHINE TAB -->
        <div id="machinesTab" class="tab-content hidden">
        <div class="card">
          <h2>Machine Overview</h2>
          <div class="card">
            <h2>Add / Edit Machine</h2>

            <form id="machineForm">
              <input type="hidden" id="machineId">

              <label>Machine Type</label>
              <select id="machineType" required>
                <option value="">Loading Types...</option>
              </select>

              <label>Machine Name</label>
              <select id="machineName" required>
                <option value="">Loading Names...</option>
              </select>

              <label>Serial Number</label>
              <input type="text" id="serialNumber" required>

              <label>Location</label>
              <select id="machineLocation" required>
                <option value="">Loading Locations...</option>
              </select>

              <label>Tank Name</label>
              <select id="machineTank">
                <option value="">Select Tank</option>
              </select>

              <button type="submit" class="primary">Save Machine</button>
            </form>
          </div>
          
          <div id="locationCards" class="location-card-container"></div>

          <h2 style="margin-top: 30px;">Tanks</h2>
          <div id="unassignedCards" class="location-card-container"></div>
        </div>
        </div>

        

      

        <!-- Supervisor Management + Trial Edit Review -->
        <section class="tab-content hidden" id="supervisor">
        <section class="card" id="adminCard">
          <h2>Supervisor Dashboard</h2>
          <p class="small-text">
            Supervisors can manage user accounts and review trial tech edits.
          </p>

          <!-- CREATE ACCOUNT -->
          <h3>Create New Account</h3>

          <label>Email:</label>
          <input type="email" id="newAdminEmail" />

          <label>Name:</label>
          <input type="text" id="newAdminname" />

          <label>Password:</label>
          <input type="password" id="newAdminPassword" />

          <label>Role:</label>
          <select id="newUserRole">
            <option value="supervisor">Supervisor</option>
            <option value="full">Full Tech</option>
            <option value="trial">Trial Tech</option>
          </select>

          <button id="createAdminBtn" type="button">Create Account</button>
          <p class="small-text" id="adminMessage"></p>

          <hr />

          <!-- USER LIST -->
          <h3>Manage Existing Accounts</h3>
          <table id="userTable" class="styled-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <hr />

          <section class="card">
            <h2>Manage Machine Types & Locations</h2>
            <p class="small-text">Supervisors can add or remove machine types and locations.</p>

            <div class="flex-row">

              <!-- Machine Types -->
              <div class="mini-card">
                <h3>Machine Types</h3>
                <input id="newMachineType" placeholder="New machine type">
                <button id="addMachineType" class="primary small">Add</button>

                <ul id="machineTypeList" class="list"></ul>
              </div>

              <!-- Locations -->
              <div class="mini-card">
                <h3>Locations</h3>
                <input id="newLocation" placeholder="New location">
                <button id="addLocation" class="primary small">Add</button>

                <ul id="locationList" class="list"></ul>
              </div>

            </div>
          </section>

          

          <!-- TRIAL EDIT REVIEW -->
          <h3>Trial Edit Review</h3>
          <table id="trialEditsTable" class="styled-table">
            <thead>
              <tr>
                <th>Machine</th>
                <th>Location</th>
                <th>Tech Name</th>
                <th>Submitted</th>
                <th style="width: 200px;">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
        </section>

      
    </main>

    <!-- ========================= -->
    <!-- FIREBASE + DASHBOARD LOGIC -->
    <!-- ========================= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
      import {
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        ref,
        onValue,
        update,
        push,
        remove,
        set,
        get,
        child,
        query,
        orderByChild,
        equalTo
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";


      const firebaseConfig = {
        apiKey: "AIzaSyBkUu-N7nkDkclV5SkDmozK2SmSur0NWNQ",
        authDomain: "welding-form.firebaseapp.com",
        databaseURL: "https://welding-form-default-rtdb.firebaseio.com",
        projectId: "welding-form",
        storageBucket: "welding-form.firebasestorage.app",
        messagingSenderId: "69271735442",
        appId: "1:69271735442:web:e438afe73f604563d22a4b",
        measurementId: "G-JSR34FQ59Y",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      //const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getDatabase(app);

      const loginCard = document.getElementById("loginCard");
      const dashboardCard = document.getElementById("dashboardCard");
      const adminCard = document.getElementById("adminCard");
      const authStatus = document.getElementById("authStatus");
      const loginMessage = document.getElementById("loginMessage");
      const adminMessage = document.getElementById("adminMessage");
      const issuesTableBody = document.querySelector("#issuesTable tbody");
      const searchInput = document.getElementById("searchInput");
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tableHeaders = document.querySelectorAll("th.sortable");
      const location = document.getElementById("location");
      const status = document.getElementById("status");

      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const createAdminBtn = document.getElementById("createAdminBtn");

      let allIssues = {};
      let currentTab = "open";
      let sortState = { key: null, direction: 1 };

      loginBtn.addEventListener("click", async () => {
        loginMessage.textContent = "";
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!email || !password) {
          loginMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
          loginMessage.textContent = "";
        } catch (error) {
          console.error(error);
          loginMessage.textContent = "Login failed. Check your credentials.";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      async function loadUserData(uid) {
        const snap = await get(ref(db, "users/" + uid));
        if (snap.exists()) {
          return snap.val(); // contains {name, email, role}
        }
        return { name: "Unknown", role: "full" };
      }


      let userRole = "full";

      // =====================
      // AUTH STATE LISTENER
      // =====================
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userData = await loadUserData(user.uid);
          userRole = userData.role || "full";

          authStatus.textContent = `Logged in as: ${userData.name}`;

          loginCard.style.display = "none";
          dashboardCard.style.display = "block";
          

          if (userRole === "supervisor") {
            document.querySelector('.tab-btn[data-tab="supervisor"]').style.display = "inline-block";
            loadAllUsers(); // loads user list
            renderTrialEditsTable(); // loads trial edits
          } else {
            document.querySelector('.tab-btn[data-tab="supervisor"]').style.display = "none";
          }

          if (userRole === "trial") {
            document.querySelector('.tab-btn[data-tab="maintenanceLog"]').style.display = "none";
            document.querySelector('.tab-btn[data-tab="booths"]').style.display = "none";
          } else {
            document.querySelector('.tab-btn[data-tab="maintenanceLog"]').style.display = "inline-block";
            document.querySelector('.tab-btn[data-tab="booths"]').style.display = "inline-block";
          }
          

          subscribeToIssues();
        } else {
          authStatus.textContent = "Not logged in";
          loginCard.style.display = "block";
          dashboardCard.style.display = "none";
          adminCard.style.display = "none";
          issuesTableBody.innerHTML = "";
        }
      });
      function formatDate(value) {
        if (!value) return "";

        // If it's already a number (timestamp)
        if (typeof value === "number") {
          return new Date(value).toLocaleDateString("en-US");
        }

        // If it's a YYYY-MM-DD string, convert safely
        if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
          const [y, m, d] = value.split("-");
          return new Date(y, m - 1, d).toLocaleDateString("en-US");
        }

        // Fallback
        return new Date(value).toLocaleDateString("en-US");
      }

      

      // =====================
      // ACCOUNT CREATION (SUPERVISOR PANEL)
      // =====================
      createAdminBtn.addEventListener("click", async () => {
        adminMessage.textContent = "";

        // Must be logged in AND a supervisor
        if (!auth.currentUser || userRole !== "supervisor") {
          adminMessage.textContent = "You are not authorized to create accounts.";
          return;
        }

        const email = document.getElementById("newAdminEmail").value.trim();
        const password = document.getElementById("newAdminPassword").value.trim();
        const role = document.getElementById("newUserRole").value;
        const name1 = document.getElementById("newAdminname").value.trim();

        if (!email || !password) {
          adminMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          // Supervisor's ID token
          const idToken = await auth.currentUser.getIdToken();
          console.log(idToken);

          // Create Firebase Auth user via backend
          const res = await fetch("/api/createUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + idToken
            },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json();

          if (!data.success) {
            adminMessage.textContent = "Error: " + data.error;
            return;
          }

          const uid = data.uid;

          // Save user info in Realtime Database
          await set(ref(db, "users/" + uid), {
            email,
            name: name1,
            role
          });

          adminMessage.textContent = `Account created with role: ${role}`;

          // Clear fields
          document.getElementById("newAdminEmail").value = "";
          document.getElementById("newAdminPassword").value = "";
          document.getElementById("newAdminname").value = "";
        } catch (error) {
          console.error(error);
          adminMessage.textContent = "Error creating account.";
        }
      });




      // =============================
      // SUPERVISOR UI: MACHINE TYPES
      // =============================
      function loadSupervisorMachineTypes() {
        const list = document.getElementById("machineTypeList");

        onValue(ref(db, "extras/machineTypes"), (snapshot) => {
          const data = snapshot.val() || {};
          list.innerHTML = "";

          Object.entries(data).forEach(([id, type]) => {
            const li = document.createElement("li");
            li.innerHTML = `
              ${type}
              <button data-id="${id}" class="deleteType">✖</button>
            `;
            list.appendChild(li);
          });

          document.querySelectorAll(".deleteType").forEach((btn) => {
            btn.onclick = () => remove(ref(db, "extras/machineTypes/" + btn.dataset.id));
          });
        });
      }

      document.getElementById("addMachineType").onclick = () => {
        const val = document.getElementById("newMachineType").value.trim();
        if (!val) return;
        push(ref(db, "extras/machineTypes"), val);
        document.getElementById("newMachineType").value = "";
      };

      // =============================
      // SUPERVISOR UI: LOCATIONS
      // =============================
      function loadSupervisorLocations() {
        const list = document.getElementById("locationList");

        onValue(ref(db, "extras/locations"), (snapshot) => {
          const data = snapshot.val() || {};
          list.innerHTML = "";

          Object.entries(data).forEach(([id, loc]) => {
            const li = document.createElement("li");
            li.innerHTML = `
              ${loc}
              <button data-id="${id}" class="deleteLocation">✖</button>
            `;
            list.appendChild(li);
          });

          document.querySelectorAll(".deleteLocation").forEach((btn) => {
            btn.onclick = () => remove(ref(db, "extras/locations/" + btn.dataset.id));
          });
        });
      }

      document.getElementById("addLocation").onclick = () => {
        const val = document.getElementById("newLocation").value.trim();
        if (!val) return;
        push(ref(db, "extras/locations"), val);
        document.getElementById("newLocation").value = "";
      };
      
      
      // =====================
      // LOAD ALL USERS FOR SUPERVISOR PANEL
      // =====================
      function loadAllUsers() {
        const userTable = document.querySelector("#userTable tbody");
        if (!userTable) return;

        onValue(ref(db, "users"), (snapshot) => {
          const users = snapshot.val() || {};
          userTable.innerHTML = "";

          Object.entries(users).forEach(([uid, user]) => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${user.name || ""}</td>
              <td>${user.email || ""}</td>
              <td>
                <select data-uid="${uid}" class="roleSelect">
                  <option value="supervisor" ${user.role === "supervisor" ? "selected" : ""}>Supervisor</option>
                  <option value="full" ${user.role === "full" ? "selected" : ""}>Full Tech</option>
                  <option value="trial" ${user.role === "trial" ? "selected" : ""}>Trial Tech</option>
                </select>
              </td>
              <td>
                <button class="danger deleteUserBtn" data-uid="${uid}" data-email="${user.email}">
                  Delete
                </button>
              </td>
            `;

            userTable.appendChild(tr);
          });

          // Handle role changes
          document.querySelectorAll(".roleSelect").forEach((sel) => {
            sel.addEventListener("change", async () => {
              const uid = sel.dataset.uid;
              const newRole = sel.value;

              await update(ref(db, "users/" + uid), { role: newRole });
              alert("Role updated.");
            });
          });

          // Handle delete buttons
          document.querySelectorAll(".deleteUserBtn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const uid = btn.dataset.uid;
              const email = btn.dataset.email;

              if (!confirm(`Delete account for ${email}?`)) return;

              try {
                const idToken = await auth.currentUser.getIdToken();

                const res = await fetch("/api/deleteUser", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + idToken
                  },
                  body: JSON.stringify({ uid })
                });

                const data = await res.json();

                if (data.success) {
                  await remove(ref(db, "users/" + uid));
                  alert("Account deleted successfully.");
                } else {
                  alert("Error: " + data.error);
                }
              } catch (err) {
                console.error(err);
                alert("Server error.");
              }
            });
          });
        });
      }

      

      // Build dynamic issue description
      function buildIssueDescription(issue) {
        let parts = [];

        if (issue.stickIssueType) {
          parts.push(
            `Stick: ${issue.stickIssueType} ${issue.stickOtherText || ""}`,
          );
        }
        if (issue.migIssueType) {
          parts.push(`MIG: ${issue.migIssueType} ${issue.migOtherText || ""}`);
        }
        if (issue.tigIssueType) {
          parts.push(`TIG: ${issue.tigIssueType} ${issue.tigOtherText || ""}`);
        }
        if (issue.plasmaCutterType || issue.plasmaIssueType) {
          parts.push(
            `Plasma (${issue.plasmaCutterType || ""}): ${issue.plasmaIssueType || ""} ${issue.plasmaOtherText || ""}`,
          );
        }
        if (issue.toolState || issue.toolType) {
          parts.push(
            `Tool: ${issue.toolState || ""} – ${issue.toolType || ""} ${issue.toolOtherText || ""}`,
          );
        }

        return parts.join("<br>");
      }

      // Render table based on currentTab, search, and sort
      function renderTable() {
        issuesTableBody.innerHTML = "";

        const query = searchInput.value.toLowerCase();

        let entries = Object.entries(allIssues).map(([id, issue]) => {
          return {
            id,
            ...issue,
            issueDetails: buildIssueDescription(issue),
          };
        });

        // Filter by tab (status)
        entries = entries.filter((item) => {
          if (currentTab === "open") return item.status !== "solved";
          if (currentTab === "solved") return item.status === "solved";
          return true;
        });

        // Filter by search
        if (query) {
          entries = entries.filter((item) => {
            const text = (
              (item.studentName || "") +
              " " +
              (item.classPeriod || "") +
              " " +
              (item.boothNumber || "") +
              " " +
              (item.processType || "") +
              " " +
              (item.issueDetails || "") +
              " " +
              (item.status || "")
            ).toLowerCase();
            return text.includes(query);
          });
        }

        // Sort
        if (sortState.key) {
          const key = sortState.key;
          const dir = sortState.direction;
          entries.sort((a, b) => {
            const va = (a[key] || "").toString().toLowerCase();
            const vb = (b[key] || "").toString().toLowerCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          });
        }
        
        // Render rows
        if (currentTab === "open"){
        document.getElementById("closedDate").classList.add("hidden");
        entries.forEach((item) => {
          const tr = document.createElement("tr");

          const statusClass =
            item.status === "solved" ? "status-solved" : "status-open";
          const statusLabel = item.status === "solved" ? "Solved" : "Open";
          let issuedate = formatDate(item.createdAt);
          tr.innerHTML = `
        <td>${item.studentName || ""}</td>
        <td>${item.classPeriod || ""}</td>
        <td>${item.boothNumber || ""}</td>
        <td>${item.processType || ""}</td>
        <td>${item.issueDetails || ""}</td>
        <td class="${statusClass}">${statusLabel}</td>
        <td>${issuedate || ""}</td>
        <td>
          <button 
            data-id="${item.id}" 
            class="toggleStatusBtn"
            style="background:${item.status === "open" ? "#4CAF50" : "#FF9800"}; color:white;"
          >
            ${item.status === "open" ? "Mark Solved" : "Mark Open"}
          </button>
        </td>
      `;

          issuesTableBody.appendChild(tr);
        });
        };

        if (currentTab === "solved"){
          entries.forEach((item) => {
            const tr = document.createElement("tr");

            const statusClass =
              item.status === "solved" ? "status-solved" : "status-open";
            const statusLabel = item.status === "solved" ? "Solved" : "Open";
            let issuedate = formatDate(item.createdAt);
            let updateddate = formatDate(item.updateddate);
            
            document.getElementById("closedDate").classList.remove("hidden");
            tr.innerHTML = `
          <td>${item.studentName || ""}</td>
          <td>${item.classPeriod || ""}</td>
          <td>${item.boothNumber || ""}</td>
          <td>${item.processType || ""}</td>
          <td>${item.issueDetails || ""}</td>
          <td class="${statusClass}">${statusLabel}</td>
          <td>${issuedate || ""}</td>
          <td>${updateddate || ""}</td>
          <td>
            <button 
              data-id="${item.id}" 
              class="toggleStatusBtn"
              style="background:${item.status === "open" ? "#4CAF50" : "#FF9800"}; color:white;"
            >
              ${item.status === "open" ? "Mark Solved" : "Mark Open"}
            </button>
          </td>
        `;

            issuesTableBody.appendChild(tr);
          });
          };
        
        // Attach listeners to toggle buttons
        document.querySelectorAll(".toggleStatusBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const issueRef = ref(db, "issues/" + id);

            const current = allIssues[id];
            const newStatus = current.status === "open" ? "solved" : "open";

            try {
              await update(issueRef, { 
                
                status: newStatus, 
                updateddate: Date.now()
                });
            } catch (error) {
              console.error(error);
              alert("Error updating issue status.");
            }
          });
        });
      }

      // Live search
      searchInput.addEventListener("input", renderTable);

      // Tabs
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentTab = btn.getAttribute("data-tab");
          renderTable();
        });
      });

      // Sorting
      tableHeaders.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (sortState.key === key) {
            sortState.direction *= -1; // toggle direction
          } else {
            sortState.key = key;
            sortState.direction = 1;
          }
          renderTable();
        });
      });

      // Subscribe to issues in Realtime Database
      function subscribeToIssues() {
        const issuesRef = ref(db, "issues");
        onValue(issuesRef, (snapshot) => {
          allIssues = snapshot.val() || {};
          renderTable();
        });
      }
      
      ///////////////////////////////
      ////// MAINTENANCE LOG ////////
      ///////////////////////////////

      
      // =====================
      // TAB SWITCHER
      // Supports: open, solved, maintenance, stock
      // =====================

      
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          // Update active button
          document.querySelectorAll(".tab-btn").forEach((b) => {
            b.classList.remove("active");
          });
          btn.classList.add("active");

          // Hide all tab contents
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.add("hidden");
          });

          // Show the selected tab
          if (tab === "open" || tab === "solved") {
            document.getElementById("issuesTab").classList.remove("hidden");
            // Your existing issues filtering logic will handle open/solved
          }

          if (tab === "maintenance") {
            document.getElementById("maintenanceTab").classList.remove("hidden");
            
            if(userRole === "supervisor")
            {
              document.getElementById("maintenanceForm").classList.remove("hidden");
              
            }
            maintSortKey = "machine";
            maintSortDir = "asc";
            renderMaintenanceTable();
          }

          if (tab === "stock") {
            document.getElementById("stockTab").classList.remove("hidden");
            document.getElementById("tankTab").classList.remove("hidden");
            document.getElementById("tankTab1").classList.remove("hidden");
            stockSortKey = "amount";
            stockSortDir = "asc";
            tankSortKey = "psi";
            tankSortDir = "asc";
            renderTankTable();
            renderStockTable();
            loadStockMachineTypes();
          }
          if (tab === "booths") {
            document.getElementById("machinesTab").classList.remove("hidden");
            loadMachineOverview();
          }
          if (tab === "maintenanceLog") {
            document.getElementById("maintenanceLogTab").classList.remove("hidden");
            logSortKey = "date";
            logSortDir = "-1";
            renderMaintenanceLogTable();
          }
          if (tab === "supervisor") { 
            document.getElementById("supervisor").classList.remove("hidden"); // Load user list + trial edits 
            loadAllUsers(); 
            renderTrialEditsTable();
            loadSupervisorMachineTypes();
            loadSupervisorLocations();
          }


        });
      });


      function getLoggedInTech() {
        const text = authStatus.textContent || "";
        return text.replace("Logged in as:", "").trim();
      }

      

      // =====================
      // REALTIME DATABASE SETUP
      // =====================
      const maintenanceRef = ref(db, "maintenance");
      const trialMaintenanceRef = ref(db, "trialMaintenance");
      const maintenanceHistoryRef = ref(db, "maintenanceHistory");

      let maintenanceData = [];
      let trialMaintenanceData = [];
      let maintenanceHistoryData = [];
      let maintSortKey = "timestamp";
      let maintSortDir = "desc";

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      const maintForm = document.getElementById("maintenanceForm");
      const maintIdInput = document.getElementById("maintId");
      const maintCancelEdit = document.getElementById("maintCancelEdit");

      maintForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const techEmail = getLoggedInTech();
        const id = maintIdInput.value; // original entry ID
        document.getElementById("maintenanceForm").classList.add("hidden");
        const editedEntry = {
          machine: machine.value.trim(),
          location: location.value.trim(),
          date: date.value,
          notes: notes.value.trim(),
          status: status.value,
        };

        //Trial Techs cannot create new entries
        if (userRole === "trial" && !id) {
          alert("Trial Techs cannot create new maintenance entries.");
          return;
        }

        // TRIAL TECH EDIT LOGIC
        if (userRole === "trial") {
          const trialRecord = {
            originalId: id,
            edited: editedEntry,
            trialTech: techEmail,
            timestamp: Date.now(),
            status: "pending",
          };

          push(trialMaintenanceRef, trialRecord);
          alert("Your edit has been submitted for supervisor review.");
        }

        // FULL TECH + SUPERVISOR LOGIC
        else {
          const entry = {
            ...editedEntry,
            tech: techEmail,
            timestamp: Date.now(),
          };

          if (id) {
            update(ref(db, `maintenance/${id}`), entry);
          } else {
            push(maintenanceRef, entry);
          }

          push(maintenanceHistoryRef, entry);
        }

        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      });

      maintCancelEdit.onclick = () => {
        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
        document.getElementById("maintenanceForm").classList.add("hidden");
      };

      // =====================
      // LIVE LISTENER (MAIN TABLE)
      // =====================
      onValue(maintenanceRef, (snapshot) => {
        const data = snapshot.val() || {};
        maintenanceData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
        renderMaintenanceTable();
      });

      // =====================
      // LIVE LISTENER (TRIAL EDITS)
      // =====================
      onValue(trialMaintenanceRef, (snapshot) => {
        const data = snapshot.val() || {};
        trialMaintenanceData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
        renderTrialEditsTable();
      });

      // =====================
      // LIVE LISTENER (HISTORY TABLE)
      // =====================
      onValue(maintenanceHistoryRef, (snapshot) => {
        const data = snapshot.val() || {};
        maintenanceHistoryData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#maintenanceTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (maintSortKey === key) {
            maintSortKey = "machine";
            maintSortDir = "asc";
          } else {
            maintSortKey = key;
            maintSortDir = "asc";
          }

          renderMaintenanceTable();
        });
      });

      // =====================
      // FILTERING
      // =====================
      const maintSearch = document.getElementById("maintSearch");
      const maintStatusFilter = document.getElementById("maintStatusFilter");
      const maintFromDate = document.getElementById("maintFromDate");
      const maintToDate = document.getElementById("maintToDate");

      [maintSearch, maintStatusFilter, maintFromDate, maintToDate].forEach((el) => {
        el.addEventListener("input", renderMaintenanceTable);
      });

      // =====================
      // RENDER MAIN MAINTENANCE TABLE
      // =====================
      function renderMaintenanceTable() {
        const tbody = document.querySelector("#maintenanceTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        //  Everyone sees the real maintenance data
        let rows = [...maintenanceData];

        const search = maintSearch.value.toLowerCase();
        const statusFilter = maintStatusFilter.value;
        const fromDate = maintFromDate.value;
        const toDate = maintToDate.value;

        rows = rows.filter((r) => {
          const matchesSearch =
            !search ||
            (r.machine || "").toLowerCase().includes(search) ||
            (r.notes || "").toLowerCase().includes(search) ||
            (r.location || "").toLowerCase().includes(search);

          const matchesStatus = !statusFilter || r.status === statusFilter;

          const dateVal = r.date || "";
          const afterFrom = !fromDate || dateVal >= fromDate;
          const beforeTo = !toDate || dateVal <= toDate;

          return matchesSearch && matchesStatus && afterFrom && beforeTo;
        });

        // Sorting
        rows.sort((a, b) => {
          let va = a[maintSortKey];
          let vb = b[maintSortKey];

          if (maintSortKey === "timestamp") {
            va = va || 0;
            vb = vb || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return maintSortDir === "asc" ? -1 : 1;
          if (va > vb) return maintSortDir === "asc" ? 1 : -1;
          return 0;
        });

        // Render rows
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          let formattedDate = formatDate(r.date);

          tr.innerHTML = `
            <td>${r.machine || ""}</td>
            <td>${r.location || ""}</td>
            <td>${formattedDate || ""}</td>
            <td>${r.notes || ""}</td>
            <td>${r.status || ""}</td>
            <td>
              <button type="button" class="secondary" data-id="${r.id}" data-action="edit">
                <i class="fa-solid fa-pen"></i>
              </button>

              ${userRole === "trial" ? "" : `
                <button type="button" class="danger" data-id="${r.id}" data-action="delete">
                  <i class="fa-regular fa-trash-can"></i>
                </button>
              `}

              <button type="button" class="secondary" data-machine="${r.machine}" data-action="viewHistory">
                <i class="fa-solid fa-clock-rotate-left"></i>
              </button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        // Button handlers
        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          btn.addEventListener("click", () => {
            if (action === "edit") {
              const row = maintenanceData.find((r) => r.id === id);
              document.getElementById("maintenanceForm").classList.remove("hidden");
              document.getElementById("maintenanceForm").scrollIntoView({
                behavior: "smooth",
                block: "start",
              });

              if (!row) return;

              maintIdInput.value = row.id;
              machine.value = row.machine || "";
              location.value = row.location || "";
              date.value = row.date || "";
              notes.value = row.notes || "";
              status.value = row.status || "Operational";

              maintCancelEdit.style.display = "inline-block";

              document.querySelector('.tab-btn[data-tab="maintenance"]').click();
            }

            if (action === "delete") {
              if (confirm("Delete this maintenance entry?")) {
                remove(ref(db, `maintenance/${id}`));
              }
            }

            if (action === "viewHistory") {
              const machineName = btn.dataset.machine;

              document.querySelector('.tab-btn[data-tab="maintenanceLog"]').click();
              document.getElementById("logSearch").value = machineName;

              renderMaintenanceLogTable();
              window.scrollTo({ top: 0, behavior: "smooth" });
            }
          });
        });
      }

      // =====================
      // SUPERVISOR TRIAL EDIT REVIEW UI
      // =====================
      function renderTrialEditsTable() {
        const table = document.getElementById("trialEditsTable");
        if (!table) return; // in case UI not present
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";

        // Only supervisors see this logically (you can also hide tab in HTML)
        if (userRole !== "supervisor") return;

        trialMaintenanceData.forEach((t) => {
          const original = maintenanceData.find((r) => r.id === t.originalId) || {};
          const edited = t.edited || {};

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${edited.machine || original.machine || ""}</td>
            <td>${edited.location || original.location || ""}</td>
            <td>${t.trialTech || ""}</td>
            <td>${formatDate(t.date || new Date(t.timestamp).toISOString())}</td>
            <td>
              <button type="button" class="secondary" data-id="${t.id}" data-action="viewOriginal">Original</button>
              <button type="button" class="secondary" data-id="${t.id}" data-action="viewEdited">Edited</button>
              <button type="button" class="success" data-id="${t.id}" data-action="approve">Approve</button>
              <button type="button" class="danger" data-id="${t.id}" data-action="reject">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Button handlers
        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const trialRecord = trialMaintenanceData.find((t) => t.id === id);
          if (!trialRecord) return;

          btn.addEventListener("click", () => {
            const original = maintenanceData.find((r) => r.id === trialRecord.originalId) || {};
            const edited = trialRecord.edited || {};

            if (action === "viewOriginal") {
              alert(
                `Original:\n\n` +
                `Machine: ${original.machine || ""}\n` +
                `Location: ${original.location || ""}\n` +
                `Date: ${original.date || ""}\n` +
                `Notes: ${original.notes || ""}\n` +
                `Status: ${original.status || ""}`
              );
            }

            if (action === "viewEdited") {
              alert(
                `Edited (by ${trialRecord.trialTech || "unknown"}):\n\n` +
                `Machine: ${edited.machine || original.machine || ""}\n` +
                `Location: ${edited.location || original.location || ""}\n` +
                `Date: ${edited.date || original.date || ""}\n` +
                `Notes: ${edited.notes || original.notes || ""}\n` +
                `Status: ${edited.status || original.status || ""}`
              );
            }

            if (action === "approve") {
              const updated = {
                machine: edited.machine || original.machine || "",
                location: edited.location || original.location || "",
                date: edited.date || original.date || "",
                notes: edited.notes || original.notes || "",
                status: edited.status || original.status || "",
                tech: trialRecord.trialTech || original.tech || "",
                timestamp: Date.now(),
              };

              update(ref(db, `maintenance/${trialRecord.originalId}`), updated);
              push(maintenanceHistoryRef, {
                ...updated,
                approvedFromTrial: true,
                trialTech: trialRecord.trialTech || "",
              });
              remove(ref(db, `trialMaintenance/${id}`));
            }

            if (action === "reject") {
              remove(ref(db, `trialMaintenance/${id}`));
            }
          });
        });
      }


      
      // =====================
      // MAINTENANCE LOG SORT STATE
      // =====================
      let logSortKey = "machine";
      let logSortDir = "asc";

      // =====================
      // MAINTENANCE LOG FILTER LISTENERS
      // =====================
      [
        document.getElementById("logSearch"),
        document.getElementById("logStatusFilter"),
        document.getElementById("logTechFilter"),
        document.getElementById("logFromDate"),
        document.getElementById("logToDate")
      ].forEach(el => {
        if (el) el.addEventListener("input", renderMaintenanceLogTable);
      });

      // =====================
      // MAINTENANCE LOG SORTING (HEADER CLICKS)
      // =====================
      document.querySelectorAll("#maintenanceLogTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (logSortKey === key) {
            logSortDir = logSortDir === "asc" ? "desc" : "asc";
          } else {
            logSortKey = key;
            logSortDir = "asc";
          }

          renderMaintenanceLogTable();
        });
      });

      // =====================
      // MAINTENANCE LOG TAB RENDERER
      // =====================
      function renderMaintenanceLogTable() {
        const tbody = document.querySelector("#maintenanceLogTable tbody");
        if (!tbody) return;

        tbody.innerHTML = "";

        let rows = [...maintenanceHistoryData];

        // Filters
        const search = document.getElementById("logSearch").value.toString().toLowerCase();
        const status = document.getElementById("logStatusFilter").value;
        const tech = document.getElementById("logTechFilter").value.toLowerCase();
        const from = document.getElementById("logFromDate").value;
        const to = document.getElementById("logToDate").value;

        rows = rows.filter((r) => {
          const machine = (r.machine || "").toString().toLowerCase();
          const notes = (r.notes || "").toString().toLowerCase();
          const location = (r.location || "").toString().toLowerCase();

          let matchesSearch;

          if (search.length === 1) {
            matchesSearch = machine=== search || location=== search;
          } else {
            matchesSearch =
              !search ||
              machine.includes(search) ||
              location.includes(search) ||
              notes.includes(search);
          }



          const matchesStatus = !status || r.status === status;
          const matchesTech = !tech || r.tech?.toLowerCase().includes(tech);

          const dateVal = r.date || "";
          const afterFrom = !from || dateVal >= from;
          const beforeTo = !to || dateVal <= to;

          return matchesSearch && matchesStatus && matchesTech && afterFrom && beforeTo;
        });

        // Sorting
        rows.sort((a, b) => {
          let va = a[logSortKey] || "";
          let vb = b[logSortKey] || "";

          va = va.toString().toLowerCase();
          vb = vb.toString().toLowerCase();

          if (va < vb) return logSortDir === "asc" ? -1 : 1;
          if (va > vb) return logSortDir === "asc" ? 1 : -1;
          return 0;
        });

        // Render rows
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          let formattedDate = formatDate(r.date);
          tr.innerHTML = `
            <td>${r.machine}</td>
            <td>${r.location}</td>
            <td>${formattedDate}</td>
            <td>${r.notes}</td>
            <td>${r.status}</td>
            <td>${r.tech || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // =====================
      // STOCK TAB
      // =====================

      // LOAD MACHINE TYPES FOR STOCK FORM
      function loadStockMachineTypes(selected = "") {
        get(ref(db, "extras/machineTypes")).then((snap) => {
          const types = snap.val() || {};
          const select = document.getElementById("stockMachineType");

          select.innerHTML = `<option value="">Select Machine Type</option>`;

          Object.values(types).forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            if (t === selected) opt.selected = true;
            select.appendChild(opt);
          });
        });
      }

      // =============================
      // COLOR FOR MACHINE TYPE CARDS
      // =============================
      function colorForMachineType(type) {
        let hash = 0;
        for (let i = 0; i < type.length; i++) {
          hash = type.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash) % 360;
        return `hsl(${hue}, 60%, 30%)`; // dark, readable background
      }



      // Realtime Database reference
      const stockRef = ref(db, "inventory/stock");

      // Local cache
      let stockData = [];
      let stockSortKey = "partType";
      let stockSortDir = "asc";

      // Elements
      const stockForm = document.getElementById("stockForm");
      const stockIdInput = document.getElementById("stockId");
      //const stockSearch = document.getElementById("stockSearch");

      // =====================
      // UTIL: Create ID from machineType + partType
      // =====================
      function makeStockKey(machineType, partType) {
        const cleanMachine = machineType.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
        const cleanPart = partType.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
        return `${cleanMachine}-${cleanPart}`;
      }

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      stockForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const partType = document.getElementById("stockPartType").value.trim();
        const machineType = document.getElementById("stockMachineType").value.trim();
        const partNumber = document.getElementById("stockPartNumber").value.trim();
        const amount = parseInt(document.getElementById("stockAmount").value, 10) || 0;

        if (!partType || !machineType) return;

        const newKey = makeStockKey(machineType, partType);
        const oldKey = stockIdInput.value;

        const entry = {
          partType,
          machineType,
          partNumber,
          amount,
          updatedAt: Date.now()
        };
        // DUPLICATE VALIDATION
        const duplicate = stockData.find(
          (p) =>
            p.machineType.toLowerCase() === machineType.toLowerCase() &&
            p.partType.toLowerCase() === partType.toLowerCase() &&
            p.id !== oldKey
        );

        if (duplicate) {
          alert("A part with this Part Type already exists for this Machine Type.");
          return;
        }


        if (oldKey && oldKey !== newKey) {
          remove(ref(db, `inventory/stock/${oldKey}`)).then(() => {
            set(ref(db, `inventory/stock/${newKey}`), entry);
          });
        } else {
          set(ref(db, `inventory/stock/${newKey}`), entry);
        }

        stockForm.reset();
        stockIdInput.value = "";
      });

      // =====================
      // LIVE LISTENER
      // =====================
      onValue(stockRef, (snapshot) => {
        const data = snapshot.val() || {};
        stockData = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        renderStockTable();
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#stockTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (stockSortKey === key) {
            stockSortDir = stockSortDir === "asc" ? "desc" : "asc";
          } else {
            stockSortKey = key;
            stockSortDir = "asc";
          }
          renderStockTable();
        });
      });

      // =====================
      // SEARCH
      // =====================
      stockSearch.addEventListener("input", renderStockTable);

      // =============================
      // CARD-BASED STOCK RENDERER
      // =============================
      function renderStockTable() {
        const container = document.getElementById("stockCardsContainer");

        const search = stockSearch.value.toLowerCase();

        // Clear old content
        container.innerHTML = `
          <h2>Inventory List</h2>
          <input type="text" id="stockSearch" placeholder="Search parts..." style="width: 100%; padding: 8px; margin-bottom: 16px;">
          <div id="stockCards"></div>
        `;

        // Re-bind search input
        document.getElementById("stockSearch").addEventListener("input", renderStockTable);

        const cardsContainer = document.getElementById("stockCards");

        
        // Group parts by machineType
        const grouped = {};
        

        stockData.forEach((p) => {
          const mt = p.machineType || "Uncategorized";
          if (!grouped[mt]) grouped[mt] = [];
          grouped[mt].push(p);
        });

        const machineTypes = Object.keys(grouped).sort((a, b) => {
          return grouped[b].length - grouped[a].length; // most parts first
        });

        machineTypes.forEach((mt) => {
          const machineTypecard = document.createElement("div");
          machineTypecard.className = "location-card";
          machineTypecard.style.borderLeft = `6px solid ${colorForMachineType(mt)}`;
          
          // Filter by search
          const parts = grouped[mt].filter((p) => {
            return (
              !search ||
              p.partType.toLowerCase().includes(search) ||
              p.machineType.toLowerCase().includes(search) ||
              p.partNumber.toLowerCase().includes(search)
            );
          });

          if (parts.length === 0) return;

          // Sort parts inside each card
          parts.sort((a, b) => {
            let va = a[stockSortKey];
            let vb = b[stockSortKey];

            if (stockSortKey === "amount") {
              va = Number(va) || 0;
              vb = Number(vb) || 0;
            } else {
              va = (va || "").toString().toLowerCase();
              vb = (vb || "").toString().toLowerCase();
            }

            if (va < vb) return stockSortDir === "asc" ? -1 : 1;
            if (va > vb) return stockSortDir === "asc" ? 1 : -1;
            return 0;
          });

          // Build card
          const card = document.createElement("div");
          card.className = "location-card";

          card.innerHTML = `
            <h3>${mt}</h3>
            ${parts
              .map(
                (p) => `
              <div class="machine-item" data-id="${p.id}">
                <div><span class="label">Part:</span> <span class="value">${p.partType}</span></div>
                <div><span class="label">Number:</span> <span class="value">${p.partNumber}</span></div>
                <div><span class="label">Amount:</span> <span class="value">${p.amount}</span></div>

                <div class="stock-buttons">
                  <button class="secondary" data-id="${p.id}" data-action="inc">+</button>
                  <button class="secondary" data-id="${p.id}" data-action="dec">-</button>
                  <button class="secondary" data-id="${p.id}" data-action="edit">Edit</button>
                  <button class="danger" data-id="${p.id}" data-action="delete">Delete</button>
                </div>
              </div>
            `
              )
              .join("")}
          `;

          cardsContainer.appendChild(card);
        });

        // Re-bind button actions
        cardsContainer.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const row = stockData.find((r) => r.id === id);

          btn.addEventListener("click", () => {
            if (!row) return;

            if (action === "inc") {
              update(ref(db, `inventory/stock/${id}`), {
                amount: (row.amount || 0) + 1,
                updatedAt: Date.now(),
              });
            }

            if (action === "dec") {
              const current = row.amount || 0;
              if (current <= 0) return;
              update(ref(db, `inventory/stock/${id}`), {
                amount: current - 1,
                updatedAt: Date.now(),
              });
            }

            if (action === "edit") {
              stockIdInput.value = id;
              document.getElementById("stockPartType").value = row.partType || "";
              loadStockMachineTypes(row.machineType || "");
              document.getElementById("stockPartNumber").value = row.partNumber || "";
              document.getElementById("stockAmount").value = row.amount ?? 0;

              document.querySelector('.tab-btn[data-tab="stock"]').click();
              document.getElementById("stockForm").scrollIntoView({ behavior: "smooth" });
            }

            if (action === "delete") {
              if (confirm("Delete this part from stock?")) {
                remove(ref(db, `inventory/stock/${id}`));
              }
            }
          });
        });
      }


      // =====================
      // TANK PSI TRACKING
      // =====================

      // DB reference
      const tankRef = ref(db, "inventory/tanks");

      // Local cache
      let tankData = [];
      let tankSortKey = "tankName";
      let tankSortDir = "asc";

      // Elements
      const tankForm = document.getElementById("tankForm");
      const tankIdInput = document.getElementById("tankId");
      const tankSearch = document.getElementById("tankSearch");

      // =====================
      // LOG PSI HISTORY
      // =====================
      function logPSIChange(tankId, psi) {
        const uniqueKey = push(ref(db, `inventory/tanks/${tankId}/psiHistory`)).key;
        push(ref(db, `inventory/tanks/${tankId}/psiHistory/`), {
          psi,
          timestamp: Date.now()
        });
      }


      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      tankForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const tankName = document.getElementById("tankName").value.trim();
        const airType = document.getElementById("tankAirType").value.trim();
        const psi = parseInt(document.getElementById("tankPSI").value, 10) || 0;

        if (!tankName) return;

        // Permanent tank ID = timestamp
        let key = tankIdInput.value;
        if (!key) {
          key = Date.now().toString(); // stable ID
        }

        const entry = {
          tankName,
          airType,
          psi,
          updatedAt: Date.now()
        };

        // Save tank
        update(ref(db, `inventory/tanks/${key}`), entry).then(() => {
          logPSIChange(key, psi); // always append history
        });

        tankForm.reset();
        tankIdInput.value = "";
      });


      // =====================
      // LIVE LISTENER
      // =====================
      onValue(tankRef, (snapshot) => {
        const data = snapshot.val() || {};
        tankData = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        renderTankTable();
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#tankTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (tankSortKey === key) {
            tankSortDir = tankSortDir === "asc" ? "desc" : "asc";
          } else {
            tankSortKey = key;
            tankSortDir = "asc";
          }

          renderTankTable();
        });
      });

      // =====================
      // SEARCH
      // =====================
      tankSearch.addEventListener("input", renderTankTable);

      // =====================
      // RENDER TABLE
      // =====================
      function renderTankTable() {
        const tbody = document.querySelector("#tankTable tbody");
        tbody.innerHTML = "";

        let rows = [...tankData];

        const search = tankSearch.value.toLowerCase();

        rows = rows.filter((r) => {
          return (
            !search ||
            (r.tankName || "").toLowerCase().includes(search) ||
            (r.airType || "").toLowerCase().includes(search)
          );
        });

        rows.sort((a, b) => {
          let va = a[tankSortKey];
          let vb = b[tankSortKey];

          if (tankSortKey === "psi") {
            va = Number(va) || 0;
            vb = Number(vb) || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return tankSortDir === "asc" ? -1 : 1;
          if (va > vb) return tankSortDir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((r) => {
          // PSI COLOR LOGIC
          let psiColor = "";
          if (r.psi <= 500) psiColor = "color: #ff4d4d; font-weight: bold;";
          else if (r.psi <= 3000) psiColor = "color: #ffd633; font-weight: bold;";
          else psiColor = "color: #008000; font-weight: bold;";

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.tankName || ""}</td>
            <td>${r.airType || ""}</td>
            <td style="${psiColor}">${r.psi ?? 0}</td>
            <td>
              <button class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const row = tankData.find((r) => r.id === id);

          btn.addEventListener("click", () => {
            if (!row) return;

            if (action === "edit") {
              tankIdInput.value = id;
              document.getElementById("tankName").value = row.tankName || "";
              document.getElementById("tankAirType").value = row.airType || "";
              document.getElementById("tankPSI").value = row.psi ?? 0;

              document.querySelector('.tab-btn[data-tab="stock"]').click();
            }

            if (action === "delete") {
              if (confirm("Are you sure you want to delete this tank?")) {
                remove(ref(db, `inventory/tanks/${id}`));
              }
            }
          });
        });
      }

      /// Machine Location Tab

      // =============================
      // LOAD MACHINE TYPES (from extras)
      // =============================
      function loadMachineTypes() {
        const dropdown = document.getElementById("machineType");

        onValue(ref(db, "extras/machineTypes"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `<option value="">Select Type</option>`;

          Object.values(data).forEach((type) => {
            dropdown.innerHTML += `<option value="${type}">${type}</option>`;
          });
        });
      }

      // =============================
      // LOAD MACHINE NAMES (from maintenance)
      // =============================
      function loadMachineNames() {
        const dropdown = document.getElementById("machineName");

        onValue(ref(db, "maintenance"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `<option value="">Select Machine</option>`;

          Object.entries(data).forEach(([id, entry]) => {
            if (entry.machine) {
              dropdown.innerHTML += `<option value="${entry.machine}">${entry.machine}</option>`;
            }
          });
        });
      }

      // =============================
      // LOAD LOCATIONS (from extras)
      // =============================
      function loadLocations() {
        const dropdown = document.getElementById("machineLocation");

        onValue(ref(db, "extras/locations"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `<option value="">Select Location</option>`;

          Object.values(data).forEach((loc) => {
            dropdown.innerHTML += `<option value="${loc}">${loc}</option>`;
          });
        });
      }

      // =============================
      // LOAD TANK NAMES (from inventory/tanks)
      // =============================
      function loadTankNames() {
        const dropdown = document.getElementById("machineTank");

        onValue(ref(db, "inventory/tanks"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `
            <option value="No Tank">No Tank Assigned</option>
            <option value="Shop Air">Shop Air</option>
          `;

          Object.entries(data).forEach(([id, tankData]) => {
            const tankName = tankData.tankName || id;
            const psi = tankData.psi ?? "-";

            dropdown.innerHTML += `
              <option value="${tankName}">
                ${tankName} (${psi} PSI)
              </option>
            `;
          });
        });
      }

      // =============================
      // MACHINE FORM SUBMIT
      // =============================
      document.getElementById("machineForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const id =
          document.getElementById("machineId").value ||
          document
            .getElementById("machineName")
            .value.toLowerCase()
            .replace(/[^a-z0-9_-]/g, "_");

        const machineData = {
          machineType: document.getElementById("machineType").value,
          machineName: document.getElementById("machineName").value,
          serialNumber: document.getElementById("serialNumber").value,
          location: document.getElementById("machineLocation").value,
          tankName: document.getElementById("machineTank").value,
          updatedAt: Date.now(),
        };

        update(ref(db, `inventory/machines/${id}`), machineData);

        document.getElementById("machineForm").reset();
        document.getElementById("machineId").value = "";

        // Refresh overview after save
        loadMachineOverview();
      });

      // =============================
      // INITIAL DROPDOWN LOADS
      // =============================
      
      loadMachineTypes();
      loadMachineNames();
      loadLocations();
      loadTankNames();

      // =============================
      // PSI COLOR HELPER
      // =============================
      function getPsiColor(psi) {
        if (psi === "-" || psi === undefined || psi === null) return "gray";
        if (psi >= 1800) return "limegreen";   // full
        if (psi >= 800) return "gold";         // medium
        return "red";                          // low
      }



      // =============================
      // MACHINE FORM SUBMIT 
      // =============================
      document.getElementById("machineForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const id =
          document.getElementById("machineId").value ||
          document
            .getElementById("machineName")
            .value.toLowerCase()
            .replace(/[^a-z0-9_-]/g, "_");

        const machineData = {
          machineType: document.getElementById("machineType").value,
          machineName: document.getElementById("machineName").value,
          serialNumber: document.getElementById("serialNumber").value,
          location: document.getElementById("machineLocation").value,
          tankName: document.getElementById("machineTank").value,
          updatedAt: Date.now(),
        };


        update(ref(db, `inventory/machines/${id}`), machineData);

        document.getElementById("machineForm").reset();
        document.getElementById("machineId").value = "";

        loadMachineOverview();
      });



      // =============================
      // MACHINE OVERVIEW
      // =============================
      function loadMachineOverview() {
        Promise.all([
          get(ref(db, "inventory/machines")),
          get(ref(db, "inventory/tanks")),
          get(ref(db, "extras/locations"))
        ]).then(([machineSnap, tankSnap, locSnap]) => {

          const machines = machineSnap.val() || {};
          const tanks = tankSnap.val() || {};
          const locations = locSnap.val() || {};

          const locationCards = document.getElementById("locationCards");
          const unassignedCards = document.getElementById("unassignedCards");

          locationCards.innerHTML = "";
          unassignedCards.innerHTML = "";



          // =============================
          // SORT LOCATIONS
          // =============================
          const locationList = Object.values(locations);

          locationList.sort((a, b) => {
            const aNum = parseInt(a, 10);
            const bNum = parseInt(b, 10);
            const aIsNum = !isNaN(aNum);
            const bIsNum = !isNaN(bNum);

            if (aIsNum && bIsNum) return aNum - bNum;
            if (aIsNum && !bIsNum) return -1;
            if (!aIsNum && bIsNum) return 1;
            return a.localeCompare(b);
          });



          // =============================
          // GROUP MACHINES BY LOCATION
          // =============================
          const grouped = {};
          locationList.forEach(loc => grouped[loc] = []);

          const unassignedMachines = [];

          Object.entries(machines).forEach(([id, m]) => {
            const psi = Object.values(tanks).find(t => t.tankName === m.tankName)?.psi ?? "-";

            const machineCard = {
              id,
              machineType: m.machineType,
              machineName: m.machineName,
              serialNumber: m.serialNumber,
              tankName: m.tankName || "No Tank",
              psi,
              updatedAt: m.updatedAt,
              location: m.location || ""
            };

            if (!m.location) {
              unassignedMachines.push(machineCard);
            } else {
              grouped[m.location].push(machineCard);
            }
          });



          // =============================
          // RENDER LOCATION CARDS
          // =============================
          locationList.forEach(loc => {
            const card = document.createElement("div");
            card.className = "location-card";

            const machinesHere = grouped[loc];

            card.innerHTML = `
              <h3>Location: ${loc}</h3>
              ${
                machinesHere.length === 0
                  ? `<p class="label">No machines assigned</p>`
                  : machinesHere.map(m => `
                    <div class="machine-item" data-id="${m.id}">
                      <button class="edit-machine-btn" data-id="${m.id}">✎</button>
                      <button class="quick-swap-btn" data-id="${m.id}">Swap</button>

                      <div><span class="label">Type:</span> <span class="value">${m.machineType}</span></div>
                      <div><span class="label">Name:</span> <span class="value">${m.machineName}</span></div>
                      <div><span class="label">Serial:</span> <span class="value">${m.serialNumber}</span></div>
                      <div><span class="label">Tank:</span> <span class="value">${m.tankName}</span></div>

                      <div>
                        <span class="label">PSI:</span>
                        <span class="value" style="color:${getPsiColor(m.psi)}">${m.psi}</span>
                      </div>

                      <div><span class="label">Updated:</span> <span class="value">${m.updatedAt ? new Date(m.updatedAt).toLocaleString() : "-"}</span></div>
                    </div>
                  `).join("")
              }
            `;

            locationCards.appendChild(card);
          });



          /* =============================
          // UNASSIGNED MACHINES CARD
          // =============================
          if (unassignedMachines.length > 0) {
            const card = document.createElement("div");
            card.className = "location-card";

            card.innerHTML = `
              <h3>Unassigned Machines</h3>
              ${
                unassignedMachines.map(m => `
                  <div class="machine-item" data-id="${m.id}">
                    <button class="edit-machine-btn" data-id="${m.id}">✎</button>
                    <button class="quick-swap-btn" data-id="${m.id}">Swap</button>

                    <div><span class="label">Type:</span> <span class="value">${m.machineType}</span></div>
                    <div><span class="label">Name:</span> <span class="value">${m.machineName}</span></div>
                    <div><span class="label">Serial:</span> <span class="value">${m.serialNumber}</span></div>
                    <div><span class="label">Tank:</span> <span class="value">${m.tankName}</span></div>

                    <div>
                      <span class="label">PSI:</span>
                      <span class="value" style="color:${getPsiColor(m.psi)}">${m.psi}</span>
                    </div>

                    <div><span class="label">Updated:</span> <span class="value">${m.updatedAt ? new Date(m.updatedAt).toLocaleString() : "-"}</span></div>
                  </div>
                `).join("")
              }
            `;

            locationCards.appendChild(card);
          }
                */


          // =============================
          // UNASSIGNED TANKS
          // =============================
          const usedTankNames = new Set(
            Object.values(machines)
              .map(m => m.tankName)
              .filter(name => name && name !== "No Tank" && name !== "Shop Air")
          );

          const unassignedTanks = Object.values(tanks).filter(t => {
            const name = t.tankName || "";
            return name && !usedTankNames.has(name);
          });

          const unassignedTankCard = document.createElement("div");
          unassignedTankCard.className = "location-card";

          unassignedTankCard.innerHTML = `
            <h3>Unassigned Tanks</h3>
            ${
              unassignedTanks.length === 0
                ? `<p class="label">All tanks are assigned</p>`
                : unassignedTanks.sort((a, b) => (b.psi ?? 99999) - (a.psi ?? 99999))
                    .map(t => `
                      <div class="machine-item" data-tank="${t.tankName}">
                        <button class="assign-tank-btn" data-tank="${t.tankName}">Assign</button>

                        <div><span class="label">Tank:</span> <span class="value">${t.tankName}</span></div>
                        <div><span class="label">Air Type:</span> <span class="value">${t.airType || "-"}</span></div>

                        <div>
                          <span class="label">PSI:</span>
                          <span class="value" style="color:${getPsiColor(t.psi)}">${t.psi ?? "-"}</span>
                        </div>

                        <div><span class="label">Updated:</span> <span class="value">${t.updatedAt ? new Date(t.updatedAt).toLocaleString() : "-"}</span></div>
                      </div>
                    `)
                    .join("")
            }
          `;

          unassignedCards.appendChild(unassignedTankCard);



          // =============================
          // ALL TANKS (with machine mapping)
          // =============================
          const tankToMachine = {};
          Object.values(machines).forEach(m => {
            if (m.tankName) tankToMachine[m.tankName] = m.machineName || "Unknown Machine";
          });

          const allTanksCard = document.createElement("div");
          allTanksCard.className = "location-card";

          allTanksCard.innerHTML = `
            <h3>All Tanks</h3>
            ${
              Object.values(tanks).length === 0
                ? `<p class="label">No tanks found</p>`
                : Object.values(tanks).filter(t => tankToMachine[t.tankName]).sort((a, b) => (a.psi ?? 99999) - (b.psi ?? 99999))  // lowest PSI first

                    .map(t => `
                      <div class="machine-item" data-tank="${t.tankName}">
                        <button class="reassign-tank-btn" data-tank="${t.tankName}">Re-Assign</button>
                        <button class="unassign-tank-btn" data-tank="${t.tankName}">Unassign</button>


                        <div><span class="label">Tank:</span> <span class="value">${t.tankName}</span></div>
                        <div><span class="label">Air Type:</span> <span class="value">${t.airType || "-"}</span></div>

                        <div>
                          <span class="label">PSI:</span>
                          <span class="value" style="color:${getPsiColor(t.psi)}">${t.psi ?? "-"}</span>
                        </div>

                        <div><span class="label">Machine:</span> <span class="value">${tankToMachine[t.tankName] || "Unassigned"}</span></div>

                        <div><span class="label">Updated:</span> <span class="value">${t.updatedAt ? new Date(t.updatedAt).toLocaleString() : "-"}</span></div>
                      </div>
                    `)
                    .join("")
            }
          `;

          unassignedCards.appendChild(allTanksCard);

        });
      }
      // =============================
      // GLOBAL CLICK HANDLER
      // =============================
      document.addEventListener("click", async (e) => {

        // EDIT MACHINE
        if (e.target.classList.contains("edit-machine-btn")) {
          const id = e.target.dataset.id;

          const snap = await get(ref(db, `inventory/machines/${id}`));
          const machine = snap.val();
          if (!machine) return;

          document.getElementById("machineId").value = id;
          document.getElementById("machineType").value = machine.machineType;
          document.getElementById("machineName").value = machine.machineName;
          document.getElementById("serialNumber").value = machine.serialNumber;
          document.getElementById("machineLocation").value = machine.location || "";
          document.getElementById("machineTank").value = machine.tankName || "";

          document.getElementById("machineForm").scrollIntoView({ behavior: "smooth" });
          return;
        }
        
        // ASSIGN TANK TO FORM
        if (e.target.classList.contains("assign-tank-btn")) {
          const tankName = e.target.dataset.tank;
          document.getElementById("machineTank").value = tankName;

          document.getElementById("machineForm").scrollIntoView({ behavior: "smooth" });
          return;
        }
        
        // QUICK SWAP TANK
        if (e.target.classList.contains("quick-swap-btn")) {
          const machineId = e.target.dataset.id;

          const snap = await get(ref(db, `inventory/machines/${machineId}`));
          const machine = snap.val();
          if (!machine) return;

          document.getElementById("machineId").value = machineId;
          document.getElementById("machineType").value = machine.machineType;
          document.getElementById("machineName").value = machine.machineName;
          document.getElementById("serialNumber").value = machine.serialNumber;
          document.getElementById("machineLocation").value = machine.location || "";

          document.getElementById("machineForm").scrollIntoView({ behavior: "smooth" });
          document.getElementById("machineTank").focus();

          return;
        }

        // QUICK UNASSIGN TANK
        if (e.target.classList.contains("unassign-tank-btn")) {
          const tankName = e.target.dataset.tank;

          // Find machine using this tank
          const machinesSnap = await get(ref(db, "inventory/machines"));
          const machinesData = machinesSnap.val() || {};

          const machineEntry = Object.entries(machinesData).find(
            ([id, m]) => m.tankName === tankName
          );

          if (!machineEntry) return;

          const [machineId] = machineEntry;

          // Remove tank from machine
          await update(ref(db, `inventory/machines/${machineId}`), {
            tankName: "",
            updatedAt: Date.now()
          });

          loadMachineOverview();
          return;
        }
      });
      
      // =============================
      // INITIAL LOAD
      // =============================
      loadMachineOverview();

      



     

      
    </script>
  </body>
</html>
