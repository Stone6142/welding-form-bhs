<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard – Welding Shop</title>
    <link rel="stylesheet" href="style.css" />

    <style>
      /* Additional small styles for sorting arrows */
      th.sortable {
        cursor: pointer;
      }
      th.sortable::after {
        content: " ⇅";
        font-size: 0.8em;
        color: #888;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Welding Shop – Teacher Dashboard</h1>
      <div class="right" id="authStatus">Not logged in</div>
    </header>

    <main>
      <!-- ========================= -->
      <!-- LOGIN CARD -->
      <!-- ========================= -->
      <section class="card" id="loginCard">
        <h2>Teacher Login</h2>

        <label>Email:</label>
        <input type="email" id="loginEmail" required />

        <label>Password:</label>
        <input type="password" id="loginPassword" required />

        <button id="loginBtn" type="button" class="primary">Login</button>
        <p class="small-text" id="loginMessage"></p>
      </section>

      <!-- ========================= -->
      <!-- DASHBOARD CARD -->
      <!-- ========================= -->
      <section class="card" id="dashboardCard" style="display: none">
        <h2>Teacher Dashboard</h2>
        <p class="small-text">
          View and update issues and machine maintenance logs submitted in the
          shop.
        </p>

        <button class="secondary" id="logoutBtn">Log Out</button>

        <!-- Search Bar (Issues only) -->
        <input
          type="text"
          id="searchInput"
          placeholder="Search issues..."
          style="width: 100%; padding: 8px; margin: 16px 0; font-size: 16px"
        />

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="open">Open Issues</button>
          <button class="tab-btn" data-tab="solved">Solved Issues</button>
          <button class="tab-btn" data-tab="maintenance">
            Maintenance Log
          </button>
        </div>

        <!-- ========================= -->
        <!-- OPEN / SOLVED ISSUES TAB -->
        <!-- ========================= -->
        <div id="issuesTab" class="tab-content">
          <table id="issuesTable">
            <thead>
              <tr>
                <th class="sortable" data-key="studentName">Student</th>
                <th class="sortable" data-key="classPeriod">Period</th>
                <th class="sortable" data-key="boothNumber">Booth</th>
                <th class="sortable" data-key="processType">Process</th>
                <th class="sortable" data-key="issueDetails">Issue Details</th>
                <th class="sortable" data-key="status">Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ========================= -->
        <!-- MAINTENANCE LOG TAB -->
        <!-- ========================= -->
        <div id="maintenanceTab" class="tab-content hidden">
          <div class="card">
            <h2>Machine Maintenance Log</h2>

            <!-- Filters -->
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 12px;
              "
            >
              <input
                type="text"
                id="maintSearch"
                placeholder="Search machine or notes..."
                style="flex: 1; padding: 8px"
              />
              <select id="maintStatusFilter" style="padding: 8px">
                <option value="">All Statuses</option>
                <option value="Operational">Operational</option>
                <option value="Needs Service">Needs Service</option>
                <option value="In Progress">In Progress</option>
                <option value="Out of Order">Out of Order</option>
              </select>
              <input type="date" id="maintFromDate" style="padding: 8px" />
              <input type="date" id="maintToDate" style="padding: 8px" />
            </div>

            <!-- Form -->
            <form id="maintenanceForm">
              <input type="hidden" id="maintId" />

              <label>Machine Name</label>
              <input type="text" id="machine" required />

              <label>Location / Booth</label>
              <input type="text" id="location" required />

              <label>Date Serviced</label>
              <input type="date" id="date" required />

              <label>Notes / Maintenance Performed</label>
              <textarea id="notes" required></textarea>

              <label>Status</label>
              <select id="status">
                <option>Operational</option>
                <option>Needs Service</option>
                <option>In Progress</option>
                <option>Out of Order</option>
              </select>

              <button type="submit" class="primary" id="maintSaveBtn">
                Save
              </button>
              <button
                type="button"
                class="secondary"
                id="maintCancelEdit"
                style="display: none"
              >
                Cancel Edit
              </button>
            </form>
          </div>

          <div class="card">
            <h2>Maintenance Records</h2>

            <table id="maintenanceTable">
              <thead>
                <tr>
                  <th class="sortable" data-key="machine">Machine</th>
                  <th class="sortable" data-key="location">Location</th>
                  <th class="sortable" data-key="date">Date</th>
                  <th class="sortable" data-key="notes">Notes</th>
                  <th class="sortable" data-key="status">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Super Admin Card -->
      <section class="card" id="adminCard" style="display: none">
        <h2>Super Admin – Create New Admin</h2>
        <p class="small-text">
          Only the super admin (<strong>welder.admin@bhs.com</strong>) can
          create new admin accounts.
        </p>

        <label>New Admin Email:</label>
        <input type="email" id="newAdminEmail" />

        <label>New Admin Password:</label>
        <input type="password" id="newAdminPassword" />

        <button id="createAdminBtn" type="button">Create Admin Account</button>
        <p class="small-text" id="adminMessage"></p>
      </section>
      <section class="card" id="adminCard1" style="display: none">
        <h2>Delete Account</h2>
        <input
          type="email"
          id="deleteEmail"
          placeholder="Enter email to delete"
        />
        <button id="deleteBtn" type="button">Delete Account</button>
        <p id="deleteMessage" class="small-text"></p>
      </section>
    </main>

    <!-- ========================= -->
    <!-- FIREBASE + DASHBOARD LOGIC -->
    <!-- ========================= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
      import {
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        ref,
        onValue,
        update,
        push,
        remove,
        set,
        get,
        child,
        query,
        orderByChild,
        equalTo
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const SUPER_ADMIN_EMAIL = "welder.admin@bhs.com";

      const firebaseConfig = {
        apiKey: "AIzaSyBkUu-N7nkDkclV5SkDmozK2SmSur0NWNQ",
        authDomain: "welding-form.firebaseapp.com",
        databaseURL: "https://welding-form-default-rtdb.firebaseio.com",
        projectId: "welding-form",
        storageBucket: "welding-form.firebasestorage.app",
        messagingSenderId: "69271735442",
        appId: "1:69271735442:web:e438afe73f604563d22a4b",
        measurementId: "G-JSR34FQ59Y",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      //const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getDatabase(app);

      const loginCard = document.getElementById("loginCard");
      const dashboardCard = document.getElementById("dashboardCard");
      const adminCard = document.getElementById("adminCard");
      const adminCard1 = document.getElementById("adminCard1");
      const authStatus = document.getElementById("authStatus");
      const loginMessage = document.getElementById("loginMessage");
      const adminMessage = document.getElementById("adminMessage");
      const issuesTableBody = document.querySelector("#issuesTable tbody");
      const searchInput = document.getElementById("searchInput");
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tableHeaders = document.querySelectorAll("th.sortable");
      const location = document.getElementById("location");

      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const createAdminBtn = document.getElementById("createAdminBtn");

      let allIssues = {}; // raw data from Firebase
      let currentTab = "open"; // 'open' or 'solved'
      let sortState = { key: null, direction: 1 }; // 1 = asc, -1 = desc

      loginBtn.addEventListener("click", async () => {
        loginMessage.textContent = "";
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!email || !password) {
          loginMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
          loginMessage.textContent = "";
        } catch (error) {
          console.error(error);
          loginMessage.textContent = "Login failed. Check your credentials.";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      // Auth state listener
      onAuthStateChanged(auth, (user) => {
        if (user) {
          authStatus.textContent = `Logged in as: ${user.email}`;
          loginCard.style.display = "none";
          dashboardCard.style.display = "block";

          if (user.email === SUPER_ADMIN_EMAIL) {
            adminCard.style.display = "block";
            adminCard1.style.display = "block";
          } else {
            adminCard.style.display = "none";
            adminCard1.style.display = "none";
          }

          subscribeToIssues();
        } else {
          authStatus.textContent = "Not logged in";
          loginCard.style.display = "block";
          dashboardCard.style.display = "none";
          adminCard.style.display = "none";
          adminCard1.style.display = "none";
          issuesTableBody.innerHTML = "";
        }
      });

      // Super admin creates new admin accounts
      createAdminBtn.addEventListener("click", async () => {
        adminMessage.textContent = "";
        const user = auth.currentUser;
        if (!user || user.email !== SUPER_ADMIN_EMAIL) {
          adminMessage.textContent =
            "You are not authorized to create admin accounts.";
          return;
        }

        const email = document.getElementById("newAdminEmail").value.trim();
        const password = document
          .getElementById("newAdminPassword")
          .value.trim();

        if (!email || !password) {
          adminMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          adminMessage.textContent = "Admin account created successfully.";
          document.getElementById("newAdminEmail").value = "";
          document.getElementById("newAdminPassword").value = "";
        } catch (error) {
          console.error(error);
          adminMessage.textContent =
            "Error creating admin account: " + error.message;
        }
      });

      // Build dynamic issue description
      function buildIssueDescription(issue) {
        let parts = [];

        if (issue.stickIssueType) {
          parts.push(
            `Stick: ${issue.stickIssueType} ${issue.stickOtherText || ""}`,
          );
        }
        if (issue.migIssueType) {
          parts.push(`MIG: ${issue.migIssueType} ${issue.migOtherText || ""}`);
        }
        if (issue.tigIssueType) {
          parts.push(`TIG: ${issue.tigIssueType} ${issue.tigOtherText || ""}`);
        }
        if (issue.plasmaCutterType || issue.plasmaIssueType) {
          parts.push(
            `Plasma (${issue.plasmaCutterType || ""}): ${issue.plasmaIssueType || ""} ${issue.plasmaOtherText || ""}`,
          );
        }
        if (issue.toolState || issue.toolType) {
          parts.push(
            `Tool: ${issue.toolState || ""} – ${issue.toolType || ""} ${issue.toolOtherText || ""}`,
          );
        }

        return parts.join("<br>");
      }

      // Render table based on currentTab, search, and sort
      function renderTable() {
        issuesTableBody.innerHTML = "";

        const query = searchInput.value.toLowerCase();

        let entries = Object.entries(allIssues).map(([id, issue]) => {
          return {
            id,
            ...issue,
            issueDetails: buildIssueDescription(issue),
          };
        });

        // Filter by tab (status)
        entries = entries.filter((item) => {
          if (currentTab === "open") return item.status !== "solved";
          if (currentTab === "solved") return item.status === "solved";
          return true;
        });

        // Filter by search
        if (query) {
          entries = entries.filter((item) => {
            const text = (
              (item.studentName || "") +
              " " +
              (item.classPeriod || "") +
              " " +
              (item.boothNumber || "") +
              " " +
              (item.processType || "") +
              " " +
              (item.issueDetails || "") +
              " " +
              (item.status || "")
            ).toLowerCase();
            return text.includes(query);
          });
        }

        // Sort
        if (sortState.key) {
          const key = sortState.key;
          const dir = sortState.direction;
          entries.sort((a, b) => {
            const va = (a[key] || "").toString().toLowerCase();
            const vb = (b[key] || "").toString().toLowerCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          });
        }

        // Render rows
        entries.forEach((item) => {
          const tr = document.createElement("tr");

          const statusClass =
            item.status === "solved" ? "status-solved" : "status-open";
          const statusLabel = item.status === "solved" ? "Solved" : "Open";

          tr.innerHTML = `
        <td>${item.studentName || ""}</td>
        <td>${item.classPeriod || ""}</td>
        <td>${item.boothNumber || ""}</td>
        <td>${item.processType || ""}</td>
        <td>${item.issueDetails || ""}</td>
        <td class="${statusClass}">${statusLabel}</td>
        <td>
          <button 
            data-id="${item.id}" 
            class="toggleStatusBtn"
            style="background:${item.status === "open" ? "#4CAF50" : "#FF9800"}; color:white;"
          >
            ${item.status === "open" ? "Mark Solved" : "Mark Open"}
          </button>
        </td>
      `;

          issuesTableBody.appendChild(tr);
        });

        // Attach listeners to toggle buttons
        document.querySelectorAll(".toggleStatusBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const issueRef = ref(db, "issues/" + id);

            const current = allIssues[id];
            const newStatus = current.status === "open" ? "solved" : "open";

            try {
              await update(issueRef, { status: newStatus });
            } catch (error) {
              console.error(error);
              alert("Error updating issue status.");
            }
          });
        });
      }

      // Live search
      searchInput.addEventListener("input", renderTable);

      // Tabs
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentTab = btn.getAttribute("data-tab");
          renderTable();
        });
      });

      // Sorting
      tableHeaders.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (sortState.key === key) {
            sortState.direction *= -1; // toggle direction
          } else {
            sortState.key = key;
            sortState.direction = 1;
          }
          renderTable();
        });
      });

      // Subscribe to issues in Realtime Database
      function subscribeToIssues() {
        const issuesRef = ref(db, "issues");
        onValue(issuesRef, (snapshot) => {
          allIssues = snapshot.val() || {};
          renderTable();
        });
      }
      const deleteBtn = document.getElementById("deleteBtn");
      const deleteEmail = document.getElementById("deleteEmail");
      const deleteMessage = document.getElementById("deleteMessage");

      deleteBtn.addEventListener("click", async () => {
        const email = deleteEmail.value.trim();
        deleteMessage.textContent = "";

        if (!email) {
          deleteMessage.textContent = "Enter an email.";
          return;
        }

        try {
          const res = await fetch("/api/deleteUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-email": auth.currentUser.email,
            },
            body: JSON.stringify({ email }),
          });

          const data = await res.json();

          if (data.success) {
            deleteMessage.textContent = "Account deleted successfully.";
            deleteEmail.value = "";
          } else {
            deleteMessage.textContent = "Error: " + data.error;
          }
        } catch (err) {
          deleteMessage.textContent = "Server error.";
        }
      });
      ///////////////////////////////
      ////// MAINTENANCE LOG ////////
      ///////////////////////////////
      // =====================
      // TAB SWITCHING
      // =====================
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          if (tab === "maintenance") {
            document.getElementById("issuesTab").classList.add("hidden");
            document
              .getElementById("maintenanceTab")
              .classList.remove("hidden");
          } else {
            document.getElementById("maintenanceTab").classList.add("hidden");
            document.getElementById("issuesTab").classList.remove("hidden");
          }
        });
      });

      // =====================
      // REALTIME DATABASE SETUP
      // =====================
      const maintenanceRef = ref(db, "maintenance");

      let maintenanceData = [];
      let maintSortKey = "timestamp";
      let maintSortDir = "desc";

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      const maintForm = document.getElementById("maintenanceForm");
      const maintIdInput = document.getElementById("maintId");
      const maintCancelEdit = document.getElementById("maintCancelEdit");

      maintForm.addEventListener("submit", (e) => {
        e.preventDefault();
        console.log(location.value)
        const entry = {
          machine: machine.value.trim(),
          location: location.value.trim(),
          date: date.value,
          notes: notes.value.trim(),
          status: status.value,
          timestamp: Date.now(),
        };

        const id = maintIdInput.value;

        if (id) {
          // UPDATE (v9 syntax)
          update(ref(db, `maintenance/${id}`), entry);
        } else {
          // CREATE (v9 syntax)
          push(maintenanceRef, entry);
        }

        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      });

      maintCancelEdit.onclick = () => {
        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      };

      // =====================
      // LIVE LISTENER (v9 syntax)
      // =====================
      onValue(maintenanceRef, (snapshot) => {
        const data = snapshot.val() || {};
        maintenanceData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
        renderMaintenanceTable();
      });

      // =====================
      // SORTING
      // =====================
      document
        .querySelectorAll("#maintenanceTable th.sortable")
        .forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.dataset.key;

            if (maintSortKey === key) {
              maintSortDir = maintSortDir === "asc" ? "desc" : "asc";
            } else {
              maintSortKey = key;
              maintSortDir = "asc";
            }

            renderMaintenanceTable();
          });
        });

      // =====================
      // FILTERING
      // =====================
      const maintSearch = document.getElementById("maintSearch");
      const maintStatusFilter = document.getElementById("maintStatusFilter");
      const maintFromDate = document.getElementById("maintFromDate");
      const maintToDate = document.getElementById("maintToDate");

      [maintSearch, maintStatusFilter, maintFromDate, maintToDate].forEach(
        (el) => {
          el.addEventListener("input", renderMaintenanceTable);
        },
      );

      // =====================
      // RENDER TABLE
      // =====================
      function renderMaintenanceTable() {
        const tbody = document.querySelector("#maintenanceTable tbody");
        tbody.innerHTML = "";

        let rows = [...maintenanceData];

        // Filtering
        const search = maintSearch.value.toLowerCase();
        const statusFilter = maintStatusFilter.value;
        const fromDate = maintFromDate.value;
        const toDate = maintToDate.value;

        rows = rows.filter((r) => {
          const matchesSearch =
            !search ||
            r.machine.toLowerCase().includes(search) ||
            r.notes.toLowerCase().includes(search) ||
            r.location.toLowerCase().includes(search);

          const matchesStatus = !statusFilter || r.status === statusFilter;

          const dateVal = r.date || "";
          const afterFrom = !fromDate || dateVal >= fromDate;
          const beforeTo = !toDate || dateVal <= toDate;

          return matchesSearch && matchesStatus && afterFrom && beforeTo;
        });

        // Sorting
        rows.sort((a, b) => {
          let va = a[maintSortKey];
          let vb = b[maintSortKey];

          if (maintSortKey === "timestamp") {
            va = va || 0;
            vb = vb || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return maintSortDir === "asc" ? -1 : 1;
          if (va > vb) return maintSortDir === "asc" ? 1 : -1;
          return 0;
        });

        // Render rows
        rows.forEach((r) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.machine || ""}</td>
            <td>${r.location || ""}</td>
            <td>${r.date || ""}</td>
            <td>${r.notes || ""}</td>
            <td>${r.status || ""}</td>
            <td>
              <button type="button" class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button type="button" class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        // Edit/Delete handlers
        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          btn.addEventListener("click", () => {
            if (action === "edit") {
              const row = maintenanceData.find((r) => r.id === id);
              if (!row) return;

              maintIdInput.value = row.id;
              machine.value = row.machine || "";
              location.value = row.location || "";
              date.value = row.date || "";
              notes.value = row.notes || "";
              status.value = row.status || "Operational";

              maintCancelEdit.style.display = "inline-block";

              document
                .querySelector('.tab-btn[data-tab="maintenance"]')
                .click();
            }

            if (action === "delete") {
              if (confirm("Delete this maintenance entry?")) {
                remove(ref(db, `maintenance/${id}`));
              }
            }
          });
        });
      }
    </script>
  </body>
</html>
