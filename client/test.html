<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard – Welding Shop</title>
    <link rel="stylesheet" href="style.css" />

    <style>
      /* Additional small styles for sorting arrows */
      th.sortable {
        cursor: pointer;
      }
      th.sortable::after {
        content: " ⇅";
        font-size: 0.8em;
        color: #888;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Welding Shop – Teacher Dashboard</h1>
      <div class="right" id="authStatus">Not logged in</div>
    </header>

    <main>
      <!-- ========================= -->
      <!-- LOGIN CARD -->
      <!-- ========================= -->
      <section class="card" id="loginCard">
        <h2>Teacher Login</h2>

        <label>Email:</label>
        <input type="email" id="loginEmail" required />

        <label>Password:</label>
        <input type="password" id="loginPassword" required />

        <button id="loginBtn" type="button" class="primary">Login</button>
        <p class="small-text" id="loginMessage"></p>
      </section>

      <!-- ========================= -->
      <!-- DASHBOARD CARD -->
      <!-- ========================= -->
      <section class="card" id="dashboardCard" style="display: none">
        <h2>Teacher Dashboard</h2>
        <p class="small-text">
          View and update issues and machine maintenance logs submitted in the
          shop.
        </p>

        <button class="secondary" id="logoutBtn">Log Out</button>

        <!-- Search Bar (Issues only) -->
        <input
          type="text"
          id="searchInput"
          placeholder="Search issues..."
          style="width: 100%; padding: 8px; margin: 16px 0; font-size: 16px"
        />

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="open">Open Issues</button>
          <button class="tab-btn" data-tab="solved">Solved Issues</button>
          <button class="tab-btn" data-tab="maintenance">
            Maintenance Log
          </button>
        </div>

        <!-- ========================= -->
        <!-- OPEN / SOLVED ISSUES TAB -->
        <!-- ========================= -->
        <div id="issuesTab" class="tab-content">
          <table id="issuesTable">
            <thead>
              <tr>
                <th class="sortable" data-key="studentName">Student</th>
                <th class="sortable" data-key="classPeriod">Period</th>
                <th class="sortable" data-key="boothNumber">Booth</th>
                <th class="sortable" data-key="processType">Process</th>
                <th class="sortable" data-key="issueDetails">Issue Details</th>
                <th class="sortable" data-key="status">Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ========================= -->
        <!-- MAINTENANCE LOG TAB -->
        <!-- ========================= -->
        <div id="maintenanceTab" class="tab-content hidden">
          <div class="card">
            <h2>Machine Maintenance Log</h2>

            <!-- Filters -->
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 12px;
              "
            >
              <input
                type="text"
                id="maintSearch"
                placeholder="Search machine or notes..."
                style="flex: 1; padding: 8px"
              />
              <select id="maintStatusFilter" style="padding: 8px">
                <option value="">All Statuses</option>
                <option value="Operational">Operational</option>
                <option value="Needs Service">Needs Service</option>
                <option value="In Progress">In Progress</option>
                <option value="Out of Order">Out of Order</option>
              </select>
              <input type="date" id="maintFromDate" style="padding: 8px" />
              <input type="date" id="maintToDate" style="padding: 8px" />
            </div>

            <!-- Form -->
            <form id="maintenanceForm">
              <input type="hidden" id="maintId" />

              <label>Machine Name</label>
              <input type="text" id="machine" required />

              <label>Location / Booth</label>
              <input type="text" id="location" required />

              <label>Date Serviced</label>
              <input type="date" id="date" required />

              <label>Notes / Maintenance Performed</label>
              <textarea id="notes" required></textarea>

              <label>Status</label>
              <select id="status">
                <option>Operational</option>
                <option>Needs Service</option>
                <option>In Progress</option>
                <option>Out of Order</option>
              </select>

              <button type="submit" class="primary" id="maintSaveBtn">
                Save
              </button>
              <button
                type="button"
                class="secondary"
                id="maintCancelEdit"
                style="display: none"
              >
                Cancel Edit
              </button>
            </form>
          </div>

          <div class="card">
            <h2>Maintenance Records</h2>

            <table id="maintenanceTable">
              <thead>
                <tr>
                  <th class="sortable" data-key="machine">Machine</th>
                  <th class="sortable" data-key="location">Location</th>
                  <th class="sortable" data-key="date">Date</th>
                  <th class="sortable" data-key="notes">Notes</th>
                  <th class="sortable" data-key="status">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- ========================= -->
    <!-- FIREBASE + DASHBOARD LOGIC -->
    <!-- ========================= -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      /* ---------------------------------------------------------
         INSERT YOUR FIREBASE CONFIG HERE
      --------------------------------------------------------- */
      const firebaseConfig = {
        apiKey: "AIzaSyBkUu-N7nkDkclV5SkDmozK2SmSur0NWNQ",
        authDomain: "welding-form.firebaseapp.com",
        databaseURL: "https://welding-form-default-rtdb.firebaseio.com",
        projectId: "welding-form",
        storageBucket: "welding-form.firebasestorage.app",
        messagingSenderId: "69271735442",
        appId: "1:69271735442:web:e438afe73f604563d22a4b",
        measurementId: "G-JSR34FQ59Y",
      };
      firebase.initializeApp(firebaseConfig);

      /* ---------------------------------------------------------
         AUTH LOGIC
      --------------------------------------------------------- */
      const loginCard = document.getElementById("loginCard");
      const dashboardCard = document.getElementById("dashboardCard");

      document.getElementById("loginBtn").onclick = () => {
        const email = loginEmail.value;
        const pass = loginPassword.value;

        firebase
          .auth()
          .signInWithEmailAndPassword(email, pass)
          .then(() => {
            loginCard.style.display = "none";
            dashboardCard.style.display = "block";
            authStatus.textContent = "Logged in as " + email;
          })
          .catch((err) => {
            loginMessage.textContent = err.message;
          });
      };

      document.getElementById("logoutBtn").onclick = () => {
        firebase.auth().signOut();
        dashboardCard.style.display = "none";
        loginCard.style.display = "block";
        authStatus.textContent = "Not logged in";
      };

      /* ---------------------------------------------------------
         TAB SWITCHING
      --------------------------------------------------------- */
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          if (tab === "maintenance") {
            issuesTab.classList.add("hidden");
            maintenanceTab.classList.remove("hidden");
          } else {
            maintenanceTab.classList.add("hidden");
            issuesTab.classList.remove("hidden");
          }
        });
      });

      /* ---------------------------------------------------------
         REALTIME DATABASE: MAINTENANCE LOG
      --------------------------------------------------------- */
      const rtdb = firebase.database();
      const maintenanceRef = rtdb.ref("maintenance");

      let maintenanceData = [];
      let maintSortKey = "timestamp";
      let maintSortDir = "desc";

      const maintForm = document.getElementById("maintenanceForm");
      const maintIdInput = document.getElementById("maintId");
      const maintCancelEdit = document.getElementById("maintCancelEdit");

      maintForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const entry = {
          machine: machine.value.trim(),
          location: location.value.trim(),
          date: date.value,
          notes: notes.value.trim(),
          status: status.value,
          timestamp: Date.now(),
        };

        const id = maintIdInput.value;
        if (id) {
          maintenanceRef.child(id).update(entry);
        } else {
          maintenanceRef.push(entry);
        }

        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      });

      maintCancelEdit.onclick = () => {
        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      };

      maintenanceRef.on("value", (snapshot) => {
        const data = snapshot.val() || {};
        maintenanceData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
        renderMaintenanceTable();
      });

      document
        .querySelectorAll("#maintenanceTable th.sortable")
        .forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.dataset.key;
            if (maintSortKey === key) {
              maintSortDir = maintSortDir === "asc" ? "desc" : "asc";
            } else {
              maintSortKey = key;
              maintSortDir = "asc";
            }
            renderMaintenanceTable();
          });
        });

      const maintSearch = document.getElementById("maintSearch");
      const maintStatusFilter = document.getElementById("maintStatusFilter");
      const maintFromDate = document.getElementById("maintFromDate");
      const maintToDate = document.getElementById("maintToDate");

      [maintSearch, maintStatusFilter, maintFromDate, maintToDate].forEach(
        (el) => {
          el.addEventListener("input", renderMaintenanceTable);
        },
      );

      function renderMaintenanceTable() {
        const tbody = document.querySelector("#maintenanceTable tbody");
        tbody.innerHTML = "";

        let rows = [...maintenanceData];

        const search = maintSearch.value.toLowerCase();
        const statusFilter = maintStatusFilter.value;
        const fromDate = maintFromDate.value;
        const toDate = maintToDate.value;

        rows = rows.filter((r) => {
          const matchesSearch =
            !search ||
            r.machine.toLowerCase().includes(search) ||
            r.notes.toLowerCase().includes(search) ||
            r.location.toLowerCase().includes(search);

          const matchesStatus = !statusFilter || r.status === statusFilter;

          const dateVal = r.date || "";
          const afterFrom = !fromDate || dateVal >= fromDate;
          const beforeTo = !toDate || dateVal <= toDate;

          return matchesSearch && matchesStatus && afterFrom && beforeTo;
        });

        rows.sort((a, b) => {
          let va = a[maintSortKey];
          let vb = b[maintSortKey];

          if (maintSortKey === "timestamp") {
            va = va || 0;
            vb = vb || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return maintSortDir === "asc" ? -1 : 1;
          if (va > vb) return maintSortDir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.machine || ""}</td>
            <td>${r.location || ""}</td>
            <td>${r.date || ""}</td>
            <td>${r.notes || ""}</td>
            <td>${r.status || ""}</td>
            <td>
              <button type="button" class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button type="button" class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          btn.addEventListener("click", () => {
            if (action === "edit") {
              const row = maintenanceData.find((r) => r.id === id);
              if (!row) return;

              maintIdInput.value = row.id;
              machine.value = row.machine || "";
              location.value = row.location || "";
              date.value = row.date || "";
              notes.value = row.notes || "";
              status.value = row.status || "Operational";

              maintCancelEdit.style.display = "inline-block";

              document
                .querySelector('.tab-btn[data-tab="maintenance"]')
                .click();
            } else if (action === "delete") {
              if (confirm("Delete this maintenance entry?")) {
                maintenanceRef.child(id).remove();
              }
            }
          });
        });
      }
    </script>
  </body>
</html>
