<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tank PSI Charts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Dark Theme Styling -->
    <style>
      body {
        background-color: #1e1e1e;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }

      h1,
      h2 {
        color: #ffffff;
      }

      /* GRID LAYOUT */
      #tankChartsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(850px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .card {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      }

      canvas {
        background-color: #111;
        border-radius: 6px;
        padding: 10px;
      }
    </style>
  </head>

  <body>
    <h1>Tank PSI Charts</h1>
    <p>Each chart shows PSI history over time for every tank.</p>
    <a href="../teacher">Back</a>
    <div id="tankChartsContainer"></div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBkUu-N7nkDkclV5SkDmozK2SmSur0NWNQ",
        authDomain: "welding-form.firebaseapp.com",
        databaseURL: "https://welding-form-default-rtdb.firebaseio.com",
        projectId: "welding-form",
        storageBucket: "welding-form.firebasestorage.app",
        messagingSenderId: "69271735442",
        appId: "1:69271735442:web:e438afe73f604563d22a4b",
        measurementId: "G-JSR34FQ59Y",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ============================
      // LOAD TANK CHARTS
      // ============================
      function loadTankCharts() {
        const container = document.getElementById("tankChartsContainer");
        container.innerHTML = "";

        onValue(ref(db, "inventory/tanks"), (snapshot) => {
          const tanks = snapshot.val() || {};
          container.innerHTML = "";

          Object.entries(tanks).forEach(([tankId, tank]) => {
            const history = tank.psiHistory || {};

            const timestamps = Object.keys(history).sort();
            const psiValues = timestamps.map((t) => history[t].psi);

            // Create card
            const card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
          <h2>${tank.tankName} (${tank.airType})</h2>
          <canvas id="chart_${tankId}" height="120"></canvas>
        `;

            container.appendChild(card);

            // Build chart
            const ctx = document
              .getElementById(`chart_${tankId}`)
              .getContext("2d");

            new Chart(ctx, {
              type: "line",
              data: {
                labels: timestamps.map((t) => {
                  const d = new Date(Number(t));
                  return d.toLocaleDateString(); // DATE ONLY
                }),
                datasets: [
                  {
                    label: "PSI",
                    data: psiValues,
                    borderColor: "#4dff4d" /* GREEN */,
                    backgroundColor: "rgba(77, 255, 77, 0.2)",
                    borderWidth: 2,
                    tension: 0.2,
                    pointRadius: 4,
                    pointBackgroundColor: psiValues.map((psi) => {
                      if (psi < 500) return "#ff4d4d"; // red
                      if (psi < 3000) return "#ffd633"; // yellow
                      return "#4dff4d"; // green
                    }),
                  },
                ],
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    min: 0,
                    max: 25000,
                    ticks: {
                      color: "#ccc",
                      stepSize: 500, // 250 PSI steps
                      callback: function (value) {
                        // Only show ticks below 3000 in 250 increments
                        if (value <= 2500) return value;
                        // Above 3000, show normal values (every 1000)
                        if (value % 1000 === 0) return value;
                        return "";
                      },
                    },
                    title: { display: true, text: "PSI" },
                  },
                  x: {
                    title: { display: true, text: "Date" },
                    ticks: { color: "#ccc" },
                  },
                },
                plugins: {
                  legend: {
                    labels: { color: "#fff" },
                  },
                },
              },
            });
          });
        });
      }

      loadTankCharts();
    </script>
  </body>
</html>
