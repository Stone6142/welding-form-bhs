<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard – Welding Shop</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="teacher.png" type="image/png">
    <style>
      /* Additional small styles for sorting arrows */
      th.sortable {
        cursor: pointer;
      }
      th.sortable::after {
        content: " ⇅";
        font-size: 0.8em;
        color: #888;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Welding Shop – Teacher Dashboard</h1>
      <div class="right" id="authStatus">Not logged in</div>
    </header>

    <main>
      <!-- ========================= -->
      <!-- LOGIN CARD -->
      <!-- ========================= -->
      <section class="card" id="loginCard">
        <h2>Teacher Login</h2>

        <label>Email:</label>
        <input type="email" id="loginEmail" required />

        <label>Password:</label>
        <input type="password" id="loginPassword" required />

        <button id="loginBtn" type="button" class="primary">Login</button>
        <p class="small-text" id="loginMessage"></p>
      </section>

      <!-- ========================= -->
      <!-- DASHBOARD CARD -->
      <!-- ========================= -->
      <section class="card" id="dashboardCard" style="display: none">
        <h2>Teacher Dashboard</h2>
        <p class="small-text">
          View and update issues and machine maintenance logs submitted in the
          shop.
        </p>

        <button class="secondary" id="logoutBtn">Log Out</button>

        <!-- Search Bar (Issues only) -->
        <input
          type="text"
          id="searchInput"
          placeholder="Search issues..."
          style="width: 100%; padding: 8px; margin: 16px 0; font-size: 16px"
        />

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="open">Open Issues</button>
          <button class="tab-btn" data-tab="solved">Solved Issues</button>
          <button class="tab-btn" data-tab="maintenance">Maintenance Log</button>
          <button class="tab-btn" data-tab="stock">Stock</button>
          <button class="tab-btn" data-tab="booths">Booth Overview</button>
        </div>

        <!-- ========================= -->
        <!-- OPEN / SOLVED ISSUES TAB -->
        <!-- ========================= -->
        <div id="issuesTab" class="tab-content">
          <table id="issuesTable">
            <thead>
              <tr>
                <th class="sortable" data-key="studentName">Student</th>
                <th class="sortable" data-key="classPeriod">Period</th>
                <th class="sortable" data-key="boothNumber">Booth</th>
                <th class="sortable" data-key="processType">Process</th>
                <th class="sortable" data-key="issueDetails">Issue Details</th>
                <th class="sortable" data-key="status">Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ========================= -->
        <!-- MAINTENANCE LOG TAB -->
        <!-- ========================= -->
        <div id="maintenanceTab" class="tab-content hidden">
          
            <h2>Machine Maintenance Log</h2>
            <div class="card">
            <h3>Maintenance Form</h3>
            <!-- Form -->
            <form id="maintenanceForm">
              <input type="hidden" id="maintId" />

              <label>Machine Name</label>
              <input type="text" id="machine" required />

              <label>Location / Booth</label>
              <input type="text" id="location" required />

              <label>Date Serviced</label>
              <input type="date" id="date" required />

              <label>Notes / Maintenance Performed</label>
              <textarea id="notes" required></textarea>

              <label>Status</label>
              <select id="status">
                <option>Operational</option>
                <option>Needs Service</option>
                <option>In Progress</option>
                <option>Out of Order</option>
              </select>

              <button type="submit" class="primary" id="maintSaveBtn">
                Save
              </button>
              </div>
              <button
                type="button"
                class="secondary"
                id="maintCancelEdit"
                style="display: none"
              >
                Cancel Edit
              </button>
            </form>
          <div class="card">
            <h3>Filters </h3>
            <!-- Filters -->
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 12px;
              "
            >
              <input
                type="text"
                id="maintSearch"
                placeholder="Search machine or notes..."
                style="flex: 1; padding: 8px"
              />
              <select id="maintStatusFilter" style="padding: 8px">
                <option value="">All Statuses</option>
                <option value="Operational">Operational</option>
                <option value="Needs Service">Needs Service</option>
                <option value="In Progress">In Progress</option>
                <option value="Out of Order">Out of Order</option>
              </select>
              <input type="date" id="maintFromDate" style="padding: 8px" />
              <input type="date" id="maintToDate" style="padding: 8px" />
            </div>
          </div>


          <div class="card">
            <h2>Maintenance Records</h2>

            <table id="maintenanceTable">
              <thead>
                <tr>
                  <th class="sortable" data-key="machine">Machine</th>
                  <th class="sortable" data-key="location">Location</th>
                  <th class="sortable" data-key="date">Date</th>
                  <th class="sortable" data-key="notes">Notes</th>
                  <th class="sortable" data-key="status">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
      <!-- ========== STOCK TAB ========== -->
      <div id="stockTab" class="tab-content hidden">
        <div class="card">
          <h2>Stock / Inventory</h2>

        
          <!-- Add / Edit Form -->
          <form id="stockForm">
            <input type="hidden" id="stockId" />

            <label>Part Type</label>
            <input type="text" id="stockPartType" required />

            <label>Machine Type</label>
            <input type="text" id="stockMachineType" required />

            <label>Part Number</label>
            <input type="text" id="stockPartNumber" required />

            <label>Amount</label>
            <input type="number" id="stockAmount" required />

            <button type="submit" class="primary">Save Part</button>
          </form>
        

        <div class="card">
          <h2>Inventory List</h2>
          <!-- Search -->
          <input
            type="text"
            id="stockSearch"
            placeholder="Search parts..."
            style="width: 100%; padding: 8px; margin-bottom: 16px;"
          />

          <table id="stockTable">
            <thead>
              <tr>
                <th class="sortable" data-key="partType">Part Type</th>
                <th class="sortable" data-key="machineType">Machine Type</th>
                <th class="sortable" data-key="partNumber">Part Number</th>
                <th class="sortable" data-key="amount">Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- ========== TANK PSI SECTION ========== -->
      <div id="tankTab1" class="card hidden" style="margin-top: 24px;" >
        <h2>Tank PSI Tracking</h2>

        

        <!-- Add / Edit Form -->
        <form id="tankForm">
          <input type="hidden" id="tankId" />

          <label>Tank Name</label>
          <input type="text" id="tankName" required />

          <label>Air Type</label>
          <input type="text" id="tankAirType" required />

          <label>PSI</label>
          <input type="number" id="tankPSI" min="0" required />

          <button type="submit" class="primary">Save Tank</button>
        </form>
      </div>

      <div class="card hidden" id="tankTab">
        <h2>Tank List</h2>
        <!-- Search -->
        
        <input
          type="text"
          id="tankSearch"
          placeholder="Search tanks..."
          style="width: 100%; padding: 8px; margin-bottom: 16px;"
        />
        <a href="/tanks" >Tank Chart</a>
        <table id="tankTable">
          <thead>
            <tr>
              <th class="sortable" data-key="tankName">Tank</th>
              <th class="sortable" data-key="airType">Air Type</th>
              <th class="sortable" data-key="psi">PSI</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
        </div>


      <!-- MACHINE TAB -->
      <div id="machinesTab" class="tab-content hidden">

        <div class="card">
          <h2>Add / Edit Machine</h2>

          <form id="machineForm">
            <input type="hidden" id="machineId">

            <label>Machine</label>
            <select id="machineType" required>
              <option value="">Select Type</option>
              <option value="Precision TIG 225">Precision TIG 225</option>
              <option value="350 MP Power Mig">350 MP Power Mig</option>
              <option value="350 MP Power Mig - TIG CONVERSION">350 MP Power Mig - TIG CONVERSION</option>
              <option value="Powermax 45 Plasma Cutter">Powermax 45 Plasma Cutter</option>
            </select>

            <label>Machine Name</label>
            <select id="machineName" required>
              <option value="">Loading...</option>
            </select>

            <label>Serial Number</label>
            <input type="text" id="serialNumber" required>

            <label>Location</label>
            <select id="machineLocation" required>
              <option value="">Select Location</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="TABLE">TABLE</option>
              <option value="BACKHALLWAY">BACKHALLWAY</option>
              <option value="OTHER">OTHER</option>
            </select>

            <label>Tank Name</label>
            <select id="machineTank">
              <option value="">Select Tank</option>
            </select>

            <button type="submit" class="primary">Save Machine</button>
          </form>
        </div>

        <div class="card">
          <h2>Machine List</h2>

          <table id="machineTable">
            <thead>
              <tr>
                <th data-col="machineType" class="sortable">Machine Type</th>
                <th data-col="machineName" class="sortable">Name</th>
                <th class="sortable">Serial</th>
                <th data-col="machineLocation"class="sortable">Booth Number</th>
                <th data-col="machineTank" class="sortable">Tank Name</th>
                <th data-col="PSI" class="sortable">PSI</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>


      <!-- Super Admin Card -->
      <section class="card" id="adminCard" style="display: none">
        <h2>Super Admin – Create New Admin</h2>
        <p class="small-text">
          Only the super admin (<strong>welder.admin@bhs.com</strong>) can
          create new admin accounts.
        </p>

        <label>New Admin Email:</label>
        <input type="email" id="newAdminEmail" />

        <label>New Admin Password:</label>
        <input type="password" id="newAdminPassword" />

        <button id="createAdminBtn" type="button">Create Admin Account</button>
        <p class="small-text" id="adminMessage"></p>
      </section>
      <section class="card" id="adminCard1" style="display: none">
        <h2>Delete Account</h2>
        <input
          type="email"
          id="deleteEmail"
          placeholder="Enter email to delete"
        />
        <button id="deleteBtn" type="button">Delete Account</button>
        <p id="deleteMessage" class="small-text"></p>
      </section>
      
    </main>

    <!-- ========================= -->
    <!-- FIREBASE + DASHBOARD LOGIC -->
    <!-- ========================= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
      import {
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        ref,
        onValue,
        update,
        push,
        remove,
        set,
        get,
        child,
        query,
        orderByChild,
        equalTo
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const SUPER_ADMIN_EMAIL = "welder.admin@bhs.com";

      async function loadFirebaseConfig() {
        const res = await fetch("https://696556b50015a3075944.sfo.appwrite.run/api/firebaseConfig");
        const config = await res.json();
        return config;
      }

      loadFirebaseConfig().then((config) => {
        
        window.firebaseAppConfig = config
      
        startApp();
      });

    loadFirebaseConfig();

    function startApp(){
      // Initialize Firebase
      //const analytics = getAnalytics(app);
      const app = initializeApp(window.firebaseAppConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      

      const loginCard = document.getElementById("loginCard");
      const dashboardCard = document.getElementById("dashboardCard");
      const adminCard = document.getElementById("adminCard");
      const adminCard1 = document.getElementById("adminCard1");
      const authStatus = document.getElementById("authStatus");
      const loginMessage = document.getElementById("loginMessage");
      const adminMessage = document.getElementById("adminMessage");
      const issuesTableBody = document.querySelector("#issuesTable tbody");
      const searchInput = document.getElementById("searchInput");
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tableHeaders = document.querySelectorAll("th.sortable");
      const location = document.getElementById("location");
      const status = document.getElementById("status");

      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const createAdminBtn = document.getElementById("createAdminBtn");

      let allIssues = {}; // raw data from Firebase
      let currentTab = "open"; // 'open' or 'solved'
      let sortState = { key: null, direction: 1 }; // 1 = asc, -1 = desc

      loginBtn.addEventListener("click", async () => {
        loginMessage.textContent = "";
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!email || !password) {
          loginMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
          loginMessage.textContent = "";
        } catch (error) {
          console.error(error);
          loginMessage.textContent = "Login failed. Check your credentials.";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      // Auth state listener
      onAuthStateChanged(auth, (user) => {
        if (user) {
          authStatus.textContent = `Logged in as: ${user.email}`;
          loginCard.style.display = "none";
          dashboardCard.style.display = "block";

          if (user.email === SUPER_ADMIN_EMAIL) {
            adminCard.style.display = "block";
            adminCard1.style.display = "block";
          } else {
            adminCard.style.display = "none";
            adminCard1.style.display = "none";
          }

          subscribeToIssues();
        } else {
          authStatus.textContent = "Not logged in";
          loginCard.style.display = "block";
          dashboardCard.style.display = "none";
          adminCard.style.display = "none";
          adminCard1.style.display = "none";
          issuesTableBody.innerHTML = "";
        }
      });

      // Super admin creates new admin accounts
      createAdminBtn.addEventListener("click", async () => {
        adminMessage.textContent = "";
        const user = auth.currentUser;
        if (!user || user.email !== SUPER_ADMIN_EMAIL) {
          adminMessage.textContent =
            "You are not authorized to create admin accounts.";
          return;
        }

        const email = document.getElementById("newAdminEmail").value.trim();
        const password = document
          .getElementById("newAdminPassword")
          .value.trim();

        if (!email || !password) {
          adminMessage.textContent = "Please enter email and password.";
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          adminMessage.textContent = "Admin account created successfully.";
          document.getElementById("newAdminEmail").value = "";
          document.getElementById("newAdminPassword").value = "";
        } catch (error) {
          console.error(error);
          adminMessage.textContent =
            "Error creating admin account: " + error.message;
        }
      });

      // Build dynamic issue description
      function buildIssueDescription(issue) {
        let parts = [];

        if (issue.stickIssueType) {
          parts.push(
            `Stick: ${issue.stickIssueType} ${issue.stickOtherText || ""}`,
          );
        }
        if (issue.migIssueType) {
          parts.push(`MIG: ${issue.migIssueType} ${issue.migOtherText || ""}`);
        }
        if (issue.tigIssueType) {
          parts.push(`TIG: ${issue.tigIssueType} ${issue.tigOtherText || ""}`);
        }
        if (issue.plasmaCutterType || issue.plasmaIssueType) {
          parts.push(
            `Plasma (${issue.plasmaCutterType || ""}): ${issue.plasmaIssueType || ""} ${issue.plasmaOtherText || ""}`,
          );
        }
        if (issue.toolState || issue.toolType) {
          parts.push(
            `Tool: ${issue.toolState || ""} – ${issue.toolType || ""} ${issue.toolOtherText || ""}`,
          );
        }

        return parts.join("<br>");
      }

      // Render table based on currentTab, search, and sort
      function renderTable() {
        issuesTableBody.innerHTML = "";

        const query = searchInput.value.toLowerCase();

        let entries = Object.entries(allIssues).map(([id, issue]) => {
          return {
            id,
            ...issue,
            issueDetails: buildIssueDescription(issue),
          };
        });

        // Filter by tab (status)
        entries = entries.filter((item) => {
          if (currentTab === "open") return item.status !== "solved";
          if (currentTab === "solved") return item.status === "solved";
          return true;
        });

        // Filter by search
        if (query) {
          entries = entries.filter((item) => {
            const text = (
              (item.studentName || "") +
              " " +
              (item.classPeriod || "") +
              " " +
              (item.boothNumber || "") +
              " " +
              (item.processType || "") +
              " " +
              (item.issueDetails || "") +
              " " +
              (item.status || "")
            ).toLowerCase();
            return text.includes(query);
          });
        }

        // Sort
        if (sortState.key) {
          const key = sortState.key;
          const dir = sortState.direction;
          entries.sort((a, b) => {
            const va = (a[key] || "").toString().toLowerCase();
            const vb = (b[key] || "").toString().toLowerCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          });
        }

        // Render rows
        entries.forEach((item) => {
          const tr = document.createElement("tr");

          const statusClass =
            item.status === "solved" ? "status-solved" : "status-open";
          const statusLabel = item.status === "solved" ? "Solved" : "Open";

          tr.innerHTML = `
        <td>${item.studentName || ""}</td>
        <td>${item.classPeriod || ""}</td>
        <td>${item.boothNumber || ""}</td>
        <td>${item.processType || ""}</td>
        <td>${item.issueDetails || ""}</td>
        <td class="${statusClass}">${statusLabel}</td>
        <td>
          <button 
            data-id="${item.id}" 
            class="toggleStatusBtn"
            style="background:${item.status === "open" ? "#4CAF50" : "#FF9800"}; color:white;"
          >
            ${item.status === "open" ? "Mark Solved" : "Mark Open"}
          </button>
        </td>
      `;

          issuesTableBody.appendChild(tr);
        });

        // Attach listeners to toggle buttons
        document.querySelectorAll(".toggleStatusBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const issueRef = ref(db, "issues/" + id);

            const current = allIssues[id];
            const newStatus = current.status === "open" ? "solved" : "open";

            try {
              await update(issueRef, { status: newStatus });
            } catch (error) {
              console.error(error);
              alert("Error updating issue status.");
            }
          });
        });
      }

      // Live search
      searchInput.addEventListener("input", renderTable);

      // Tabs
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentTab = btn.getAttribute("data-tab");
          renderTable();
        });
      });

      // Sorting
      tableHeaders.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (sortState.key === key) {
            sortState.direction *= -1; // toggle direction
          } else {
            sortState.key = key;
            sortState.direction = 1;
          }
          renderTable();
        });
      });

      // Subscribe to issues in Realtime Database
      function subscribeToIssues() {
        const issuesRef = ref(db, "issues");
        onValue(issuesRef, (snapshot) => {
          allIssues = snapshot.val() || {};
          renderTable();
        });
      }
      const deleteBtn = document.getElementById("deleteBtn");
      const deleteEmail = document.getElementById("deleteEmail");
      const deleteMessage = document.getElementById("deleteMessage");

      deleteBtn.addEventListener("click", async () => {
        const email = deleteEmail.value.trim();
        deleteMessage.textContent = "";

        if (!email) {
          deleteMessage.textContent = "Enter an email.";
          return;
        }

        try {
          const res = await fetch("https://696556b50015a3075944.sfo.appwrite.run/api/firebaseConfig/api/deleteUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-email": auth.currentUser.email,
            },
            body: JSON.stringify({ email }),
          });

          const data = await res.json();

          if (data.success) {
            deleteMessage.textContent = "Account deleted successfully.";
            deleteEmail.value = "";
          } else {
            deleteMessage.textContent = "Error: " + data.error;
          }
        } catch (err) {
          deleteMessage.textContent = "Server error.";
        }
      });
      ///////////////////////////////
      ////// MAINTENANCE LOG ////////
      ///////////////////////////////

      
      // =====================
      // TAB SWITCHER
      // Supports: open, solved, maintenance, stock
      // =====================

      
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          // Update active button
          document.querySelectorAll(".tab-btn").forEach((b) => {
            b.classList.remove("active");
          });
          btn.classList.add("active");

          // Hide all tab contents
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.add("hidden");
          });

          // Show the selected tab
          if (tab === "open" || tab === "solved") {
            document.getElementById("issuesTab").classList.remove("hidden");
            // Your existing issues filtering logic will handle open/solved
          }

          if (tab === "maintenance") {
            document.getElementById("maintenanceTab").classList.remove("hidden");
          }

          if (tab === "stock") {
            document.getElementById("stockTab").classList.remove("hidden");
            document.getElementById("tankTab").classList.remove("hidden");
            document.getElementById("tankTab1").classList.remove("hidden");
          }
          if (tab === "booths") {
            document.getElementById("machinesTab").classList.remove("hidden");
          }

        });
      });


      // =====================
      // REALTIME DATABASE SETUP
      // =====================
      const maintenanceRef = ref(db, "maintenance");

      let maintenanceData = [];
      let maintSortKey = "timestamp";
      let maintSortDir = "desc";

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      const maintForm = document.getElementById("maintenanceForm");
      const maintIdInput = document.getElementById("maintId");
      const maintCancelEdit = document.getElementById("maintCancelEdit");

      maintForm.addEventListener("submit", (e) => {
        e.preventDefault();
        console.log(status.value)
        const entry = {
          machine: machine.value.trim(),
          location: location.value.trim(),
          date: date.value,
          notes: notes.value.trim(),
          status: status.value,
          timestamp: Date.now(),
        };

        const id = maintIdInput.value;

        if (id) {
          // UPDATE (v9 syntax)
          update(ref(db, `maintenance/${id}`), entry);
        } else {
          // CREATE (v9 syntax)
          push(maintenanceRef, entry);
        }

        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      });

      maintCancelEdit.onclick = () => {
        maintForm.reset();
        maintIdInput.value = "";
        maintCancelEdit.style.display = "none";
      };

      // =====================
      // LIVE LISTENER (v9 syntax)
      // =====================
      onValue(maintenanceRef, (snapshot) => {
        const data = snapshot.val() || {};
        maintenanceData = Object.entries(data).map(([id, val]) => ({
          id,
          ...val,
        }));
        renderMaintenanceTable();
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#maintenanceTable th.sortable").forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.dataset.key;

            if (maintSortKey === key) {
              maintSortDir = maintSortDir === "asc" ? "desc" : "asc";
            } else {
              maintSortKey = key;
              maintSortDir = "asc";
            }

            renderMaintenanceTable();
          });
        });

      // =====================
      // FILTERING
      // =====================
      const maintSearch = document.getElementById("maintSearch");
      const maintStatusFilter = document.getElementById("maintStatusFilter");
      const maintFromDate = document.getElementById("maintFromDate");
      const maintToDate = document.getElementById("maintToDate");

      [maintSearch, maintStatusFilter, maintFromDate, maintToDate].forEach(
        (el) => {
          el.addEventListener("input", renderMaintenanceTable);
        },
      );

      // =====================
      // RENDER TABLE
      // =====================
      function renderMaintenanceTable() {
        const tbody = document.querySelector("#maintenanceTable tbody");
        tbody.innerHTML = "";

        let rows = [...maintenanceData];

        // Filtering
        const search = maintSearch.value.toLowerCase();
        const statusFilter = maintStatusFilter.value;
        const fromDate = maintFromDate.value;
        const toDate = maintToDate.value;

        rows = rows.filter((r) => {
          const matchesSearch =
            !search ||
            r.machine.toLowerCase().includes(search) ||
            r.notes.toLowerCase().includes(search) ||
            r.location.toLowerCase().includes(search);

          const matchesStatus = !statusFilter || r.status === statusFilter;

          const dateVal = r.date || "";
          const afterFrom = !fromDate || dateVal >= fromDate;
          const beforeTo = !toDate || dateVal <= toDate;

          return matchesSearch && matchesStatus && afterFrom && beforeTo;
        });

        // Sorting
        rows.sort((a, b) => {
          let va = a[maintSortKey];
          let vb = b[maintSortKey];

          if (maintSortKey === "timestamp") {
            va = va || 0;
            vb = vb || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return maintSortDir === "asc" ? -1 : 1;
          if (va > vb) return maintSortDir === "asc" ? 1 : -1;
          return 0;
        });

        // Render rows
        rows.forEach((r) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.machine || ""}</td>
            <td>${r.location || ""}</td>
            <td>${r.date || ""}</td>
            <td>${r.notes || ""}</td>
            <td>${r.status || ""}</td>
            <td>
              <button type="button" class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button type="button" class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        // Edit/Delete handlers
        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          btn.addEventListener("click", () => {
            if (action === "edit") {
              const row = maintenanceData.find((r) => r.id === id);
              if (!row) return;

              maintIdInput.value = row.id;
              machine.value = row.machine || "";
              location.value = row.location || "";
              date.value = row.date || "";
              notes.value = row.notes || "";
              status.value = row.status || "Operational";

              maintCancelEdit.style.display = "inline-block";

              document
                .querySelector('.tab-btn[data-tab="maintenance"]')
                .click();
            }

            if (action === "delete") {
              if (confirm("Delete this maintenance entry?")) {
                remove(ref(db, `maintenance/${id}`));
              }
            }
          });
        });
      }



      // =====================
      // STOCK TAB SETUP
      // =====================

      // Realtime Database reference
      const stockRef = ref(db, "inventory/stock");

      // Local cache
      let stockData = [];
      let stockSortKey = "partType";
      let stockSortDir = "asc";

      // Elements
      const stockForm = document.getElementById("stockForm");
      const stockIdInput = document.getElementById("stockId");
      const stockSearch = document.getElementById("stockSearch");

      // =====================
      // UTIL: Create ID from machineType + partType
      // =====================
      function makeStockKey(machineType, partType) {
        const cleanMachine = machineType.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
        const cleanPart = partType.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
        return `${cleanMachine}-${cleanPart}`;
      }

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      stockForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const partType = document.getElementById("stockPartType").value.trim();
        const machineType = document.getElementById("stockMachineType").value.trim();
        const partNumber = document.getElementById("stockPartNumber").value.trim();
        const amount = parseInt(document.getElementById("stockAmount").value, 10) || 0;

        if (!partType || !machineType) return;

        const newKey = makeStockKey(machineType, partType);
        const oldKey = stockIdInput.value;

        const entry = {
          partType,
          machineType,
          partNumber,
          amount,
          updatedAt: Date.now()
        };

        if (oldKey && oldKey !== newKey) {
          remove(ref(db, `inventory/stock/${oldKey}`)).then(() => {
            set(ref(db, `inventory/stock/${newKey}`), entry);
          });
        } else {
          set(ref(db, `inventory/stock/${newKey}`), entry);
        }

        stockForm.reset();
        stockIdInput.value = "";
      });

      // =====================
      // LIVE LISTENER
      // =====================
      onValue(stockRef, (snapshot) => {
        const data = snapshot.val() || {};
        stockData = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        renderStockTable();
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#stockTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (stockSortKey === key) {
            stockSortDir = stockSortDir === "asc" ? "desc" : "asc";
          } else {
            stockSortKey = key;
            stockSortDir = "asc";
          }

          renderStockTable();
        });
      });

      // =====================
      // SEARCH
      // =====================
      stockSearch.addEventListener("input", renderStockTable);

      // =====================
      // RENDER TABLE
      // =====================
      function renderStockTable() {
        const tbody = document.querySelector("#stockTable tbody");
        tbody.innerHTML = "";

        let rows = [...stockData];

        const search = stockSearch.value.toLowerCase();

        rows = rows.filter((r) => {
          return (
            !search ||
            (r.partType || "").toLowerCase().includes(search) ||
            (r.machineType || "").toLowerCase().includes(search) ||
            (r.partNumber || "").toLowerCase().includes(search)
          );
        });

        rows.sort((a, b) => {
          let va = a[stockSortKey];
          let vb = b[stockSortKey];

          if (stockSortKey === "amount") {
            va = Number(va) || 0;
            vb = Number(vb) || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return stockSortDir === "asc" ? -1 : 1;
          if (va > vb) return stockSortDir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.partType || ""}</td>
            <td>${r.machineType || ""}</td>
            <td>${r.partNumber || ""}</td>
            <td>${r.amount ?? 0}</td>
            <td>
              <button class="secondary" data-id="${r.id}" data-action="inc">+</button>
              <button class="secondary" data-id="${r.id}" data-action="dec">-</button>
              <button class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const row = stockData.find((r) => r.id === id);

          btn.addEventListener("click", () => {
            if (!row) return;

            if (action === "inc") {
              update(ref(db, `inventory/stock/${id}`), {
                amount: (row.amount || 0) + 1,
                updatedAt: Date.now()
              });
            }

            if (action === "dec") {
              const current = row.amount || 0;
              if (current <= 0) return;
              update(ref(db, `inventory/stock/${id}`), {
                amount: current - 1,
                updatedAt: Date.now()
              });
            }

            if (action === "edit") {
              stockIdInput.value = id;
              document.getElementById("stockPartType").value = row.partType || "";
              document.getElementById("stockMachineType").value = row.machineType || "";
              document.getElementById("stockPartNumber").value = row.partNumber || "";
              document.getElementById("stockAmount").value = row.amount ?? 0;

              document.querySelector('.tab-btn[data-tab="stock"]').click();
            }

            if (action === "delete") {
              if (confirm("Delete this part from stock?")) {
                remove(ref(db, `inventory/stock/${id}`));
              }
            }
          });
        });
      }

      // =====================
      // TANK PSI TRACKING
      // =====================

      // DB reference
      const tankRef = ref(db, "inventory/tanks");

      // Local cache
      let tankData = [];
      let tankSortKey = "tankName";
      let tankSortDir = "asc";

      // Elements
      const tankForm = document.getElementById("tankForm");
      const tankIdInput = document.getElementById("tankId");
      const tankSearch = document.getElementById("tankSearch");

      // =====================
      // LOG PSI HISTORY
      // =====================
      function logPSIChange(tankId, psi) {
        const logRef = ref(db, `inventory/tanks/${tankId}/psiHistory/${Date.now()}`);
        set(logRef, { psi });
      }

      // =====================
      // FORM SUBMIT (CREATE / UPDATE)
      // =====================
      tankForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const tankName = document.getElementById("tankName").value.trim();
        const airType = document.getElementById("tankAirType").value.trim();
        const psi = parseInt(document.getElementById("tankPSI").value, 10) || 0;

        if (!tankName) return;

        const key = tankName.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
        const oldKey = tankIdInput.value;

        const entry = {
          tankName,
          airType,
          psi,
          updatedAt: Date.now()
        };

        if (oldKey && oldKey !== key) {
          remove(ref(db, `inventory/tanks/${oldKey}`)).then(() => {
            set(ref(db, `inventory/tanks/${key}`), entry).then(() => {
              logPSIChange(key, psi);
            });
          });
        } else {
          set(ref(db, `inventory/tanks/${key}`), entry).then(() => {
            logPSIChange(key, psi);
          });
        }

        tankForm.reset();
        tankIdInput.value = "";
      });

      // =====================
      // LIVE LISTENER
      // =====================
      onValue(tankRef, (snapshot) => {
        const data = snapshot.val() || {};
        tankData = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        renderTankTable();
      });

      // =====================
      // SORTING
      // =====================
      document.querySelectorAll("#tankTable th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;

          if (tankSortKey === key) {
            tankSortDir = tankSortDir === "asc" ? "desc" : "asc";
          } else {
            tankSortKey = key;
            tankSortDir = "asc";
          }

          renderTankTable();
        });
      });

      // =====================
      // SEARCH
      // =====================
      tankSearch.addEventListener("input", renderTankTable);

      // =====================
      // RENDER TABLE
      // =====================
      function renderTankTable() {
        const tbody = document.querySelector("#tankTable tbody");
        tbody.innerHTML = "";

        let rows = [...tankData];

        const search = tankSearch.value.toLowerCase();

        rows = rows.filter((r) => {
          return (
            !search ||
            (r.tankName || "").toLowerCase().includes(search) ||
            (r.airType || "").toLowerCase().includes(search)
          );
        });

        rows.sort((a, b) => {
          let va = a[tankSortKey];
          let vb = b[tankSortKey];

          if (tankSortKey === "psi") {
            va = Number(va) || 0;
            vb = Number(vb) || 0;
          } else {
            va = (va || "").toString().toLowerCase();
            vb = (vb || "").toString().toLowerCase();
          }

          if (va < vb) return tankSortDir === "asc" ? -1 : 1;
          if (va > vb) return tankSortDir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((r) => {
          // PSI COLOR LOGIC
          let psiColor = "";
          if (r.psi <= 500) psiColor = "color: #ff4d4d; font-weight: bold;";
          else if (r.psi <= 3000) psiColor = "color: #ffd633; font-weight: bold;";
          else psiColor = "color: #008000; font-weight: bold;"
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${r.tankName || ""}</td>
            <td>${r.airType || ""}</td>
            <td style="${psiColor}">${r.psi ?? 0}</td>
            <td>
              <button class="secondary" data-id="${r.id}" data-action="edit">Edit</button>
              <button class="danger" data-id="${r.id}" data-action="delete">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });
      
        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const row = tankData.find((r) => r.id === id);

          btn.addEventListener("click", () => {
            if (!row) return;

            if (action === "edit") {
              tankIdInput.value = id;
              document.getElementById("tankName").value = row.tankName || "";
              document.getElementById("tankAirType").value = row.airType || "";
              document.getElementById("tankPSI").value = row.psi ?? 0;

              document.querySelector('.tab-btn[data-tab="stock"]').click();
              
            }
            if (action === "delete") {
              if (confirm("Are you sure you want to delete this tank?")) {
                remove(ref(db, `inventory/tanks/${id}`));
              }
            }

          });
        });
      }


      /// Machine Location Tab

      function loadMachineNames() {
        const dropdown = document.getElementById("machineName");

        onValue(ref(db, "maintenance"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `<option value="">Select Machine</option>`;

          Object.entries(data).forEach(([id, entry]) => {
            if (entry.machine) {
              dropdown.innerHTML += `<option value="${entry.machine}">${entry.machine}</option>`;
            }
          });
        });
      }
      document.getElementById("machineForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const id = document.getElementById("machineId").value || 
                   document.getElementById("machineName").value.toLowerCase().replace(/[^a-z0-9_-]/g, "_");

        const machineData = {
          machineType: document.getElementById("machineType").value,
          machineName: document.getElementById("machineName").value,
          serialNumber: document.getElementById("serialNumber").value,
          location: document.getElementById("machineLocation").value,
          tankName: document.getElementById("machineTank").value,
          updatedAt: Date.now()
        };

        set(ref(db, `inventory/machines/${id}`), machineData);

        document.getElementById("machineForm").reset();
        document.getElementById("machineId").value = "";
      });

      

      loadMachineNames();
      function loadMachineTable() {
        const tbody = document.querySelector("#machineTable tbody");

        // Load both machines and tanks
        Promise.all([
          get(ref(db, "inventory/machines")),
          get(ref(db, "inventory/tanks"))
        ]).then(([machineSnap, tankSnap]) => {
          const machines = machineSnap.val() || {};
          const tanks = tankSnap.val() || {};

          tbody.innerHTML = "";

          Object.entries(machines).forEach(([id, m]) => {
            const tr = document.createElement("tr");

            // ⭐ PART 1 — Find the tank PSI
            let psi = "-";
            Object.values(tanks).forEach((t) => {
              if (t.tankName === m.tankName) {
                psi = t.psi ?? "-";
              }
            });

            // Build the row
            tr.innerHTML = `
              <td>${m.machineType}</td>
              <td>${m.machineName}</td>
              <td>${m.serialNumber}</td>
              <td>${m.location}</td>
              <td>${m.tankName || "-"}</td>
              <td>${psi}</td>
              <td>
                <button class="secondary" data-id="${id}" data-action="edit">Edit</button>
                <button class="danger" data-id="${id}" data-action="delete">Delete</button>
              </td>
            `;

            tbody.appendChild(tr);
          });

          attachMachineActions();
        });
        makeTableSortable("machineTable");

      }


      loadMachineTable();

      function attachMachineActions() {
        const tbody = document.querySelector("#machineTable tbody");

        tbody.querySelectorAll("button[data-action]").forEach((btn) => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          btn.addEventListener("click", () => {
            if (action === "edit") {
              get(ref(db, `inventory/machines/${id}`)).then((snap) => {
                const m = snap.val();
                if (!m) return;

                document.getElementById("machineId").value = id;
                document.getElementById("machineType").value = m.machineType;
                document.getElementById("machineName").value = m.machineName;
                document.getElementById("serialNumber").value = m.serialNumber;
                document.getElementById("machineLocation").value = m.location;
                document.getElementById("machineTank").value = m.tankName || "";
                //document.querySelector('.tab-btn[data-tab="machines"]').click();
              });
            }

            if (action === "delete") {
              if (confirm("Delete this machine?")) {
                remove(ref(db, `inventory/machines/${id}`));
              }
            }
          });
        });
      }
      function loadTankNames() {
        const dropdown = document.getElementById("machineTank");

        onValue(ref(db, "inventory/tanks"), (snapshot) => {
          const data = snapshot.val() || {};

          dropdown.innerHTML = `
            <option value="No Tank">No Tank Assigned</option>
            <option value="Shop Air">Shop Air</option>
          `;

          Object.entries(data).forEach(([id, tankData]) => {
            const tankName = tankData.tankName || id; // fallback if missing
            const psi = tankData.psi ?? "-";

            dropdown.innerHTML += `
              <option value="${tankName}">
                ${tankName} (${psi} PSI)
              </option>
            `;
          });
        });
      }

      loadTankNames();

      //machine table sorting
      function makeTableSortable(tableId) {
        const table = document.getElementById(tableId);
        const headers = table.querySelectorAll("th[data-col]");
        let sortState = {};

        headers.forEach((header) => {  
          header.style.cursor = "pointer";

          header.addEventListener("click", () => {
            const col = header.dataset.col;
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // Toggle sort direction
            sortState[col] = sortState[col] === "asc" ? "desc" : "asc";
            const direction = sortState[col];

            rows.sort((a, b) => {
              const aText = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.toLowerCase();
              const bText = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.toLowerCase();

              if (aText < bText) return direction === "asc" ? -1 : 1;
              if (aText > bText) return direction === "asc" ? 1 : -1;
              return 0;
            });

            // Re-append sorted rows
            rows.forEach((row) => tbody.appendChild(row));
          });
        });
      }
    }


      

      
    </script>
  </body>
</html>
